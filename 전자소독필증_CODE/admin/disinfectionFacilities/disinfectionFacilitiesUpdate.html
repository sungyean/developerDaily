<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>거점소독시설 관리자 사이트</title>
	<link rel="stylesheet" href="../assets/css/common.css">
	<link rel="stylesheet" href="../assets/css/fonts.css">
	<link rel="stylesheet" href="../assets/css/jquery-ui.css">
	<link rel="stylesheet" href="../assets/css/jquery-ui-1.11.0.css">
	<link rel="stylesheet" href="../assets/css/style.css">
	<script src="../assets/js/jquery-3.4.1.min.js"></script>
	<script src="../assets/js/jquery-ui.min.js"></script>
	<script src="../assets/js/jquery.mCustomScrollbar.min.js"></script>
	<script src="../assets/js/custom.js"></script>
	<!--주소검색 API-->
	<script src="http://dmaps.daum.net/map_js_init/postcode.v2.js"></script>
	<!--JQUERY modal-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />
	<!-- JQuery validation -->
	<script type="text/javascript" src="../assets/js/jquery.validate.min.js"></script>
	<script type="text/javascript" src="../assets/js/additional-methods.min.js"></script>
	<script type="text/javascript" src="../assets/js/messages_ko.min.js"></script>
	<script type="text/javascript" src="../../assets/js/comm.js"></script>
</head>
<body>
	<div class="header">
	
		<!-- TOP SECTION -->
		<div id="headers"></div>
		<!-- //TOP SECTION -->
		<!-- GNB SECTION -->
		<div id="gnb"></div>
		<!-- //GNB SECTION -->
		<!-- contents -->
		<div class="contents clearfix" id="contents">
			<div class="lnb-wrap">
				<h2 class="lnb-tit"><span>거점소독시설 관리</span></h2>
				<ul class="lnb-menu">
					<li class="on">
						<a href="disinfectionFacilitiesList.html">거점소독시설 현황</a>
						<ul>
							<li><a href="disinfectionFacilitiesAdd.html">거점소독시설 등록</a></li>
						</ul>
					</li>                    
				</ul>
			</div>

			<form id="updateDisinfectionFacilities" method="POST" onsubmit="return false;">
				<div class="contents-inn">
					<h3 class="page-tit"><span>거점소독시설 수정</span></h3>
					<input type="hidden" id="ty" name=ty value="DSNF_FCLTY">
					<div class="tb-wrap Add">
						<h4 class="tb-tit"><span class="icon-bullet"><img src="../assets/images/bullet1.png" alt="테이블 제목"></span>거점소독시설 기본정보</h4>
						<table>                        
							<tbody>
								<tr>
									<th><span class="mark-essential">*</span>거점소독시설 명</th>
									<td class="condition-input-box">
										<div class="search-box">
											<input type="search" id="nm" name="nm" class="condition search">
										</div>
									</td> 
									<th><span class="mark-essential">*</span>운영 상태</th>
									<td class="condition-input-box">
										<select id="status" name="status" class="">                    
											<option value="" selected="">운영상태</option>                    
											<option value="NRMLT">정상</option>                    
											<option value="WAIT">대기</option>                    
											<option value="EMGNC">비상</option>                    
											<option value="CLS">폐쇄</option>                 
										</select>
									</td>
								</tr>
								<tr>
									<th><span class="mark-essential">*</span>지역 정보</th>
									<td class="condition-input-box">
										<select id="area" name="area" class="">                    
											<option value="" selected="">지역선택</option>
											<option value="SU">서울</option>                    
											<option value="GG">경기</option>                    
											<option value="IC">인천</option>                    
											<option value="BS">부산</option>                    
											<option value="DG">대구</option>   
											<option value="GJ">광주</option>                    
											<option value="DJ">대전</option>                    
											<option value="US">울산</option>                    
											<option value="SJ">세종</option>                    
											<option value="GW">강원</option>    
											<option value="GN">경남</option>                    
											<option value="GB">경북</option>                    
											<option value="JN">전남</option>                    
											<option value="JNBK">전북</option>                    
											<option value="CHN">충남</option> 
											<option value="CB">충북</option> 
											<option value="JJ">제주</option>                  
										</select>
									</td>
									<th><span class="mark-essential">*</span>주소</th>
									<td class="condition-input-box">
										<div class="search-box">
											지번/도로명 &nbsp;<input type="text" id="rnAdres1" name="rnAdres1" class="condition search"><button type="button" class="btn-td-search" onClick="addressModal()">검색</button>
											<br>상세주소&nbsp;<input type="text" id="adres2" name="adres2" class="condition search">
											<input type="hidden" id="zip" name="zip">
											<input type="hidden" id="lmnAdres1" name="lmnAdres1">
											<input type="hidden" id="userSelectedType" name="userSelectedType">
										</div>
									</td> 
								</tr>
							</tbody>
						</table>
					</div> 
					<div class="tb-wrap">
						<h4 class="tb-tit"><span class="icon-bullet"><img src="../assets/images/bullet1.png" alt="테이블 제목"></span>거점소독시설 담당공무원 정보</h4>
						<div class="btn-add-wrap">
							<button type="button" class="btn-add" onclick="location.href='../system/systemAdd.html'"><span class="icon-add"><img src="../assets/images/icon-add.png" alt="등록하기"></span>담당공무원 등록하기</button>
						</div>
						<table>   
							<thead>
								<th>No</th>
								<th>소속</th>
								<th>직급</th>
								<th>이름</th>
								<th>ID</th>
								<th>연락처</th>
								<th>근무상태</th>
								<th>가입일</th>
								<th>삭제</th>
							</thead>                     
							<tbody id="chrgPbsvnts">
								<tr>
									<td>2</td>
									<td>지방직</td>
									<td>8급(실무자)</td>
									<td>홍길동</td>
									<td>kim1234</td>
									<td>010-1234-1234</td>
									<td>정상</td>
									<td>2020-07-07 PM 12:07:46</td>
									<td><button class="btn-td-delete">삭제</button></td>
								</tr>
							</tbody>
						</table>
					</div>
					<div class="btn-tbView-box">
						<button type="submit" class="btn-save"><span class="icon-save"><img src="../assets/images/icon-save.png" alt="저장"></span>저장</button>
						<button type="button" class="btn-list" onclick='gotoList();'><span class="icon-list"><img src="../assets/images/icon-list.png" alt="목록"></span>목록</button> 
					</div>
				</div>
			</form>
		</div>
		<!-- //contents -->
	</div>
	<!-- 주소검색 dialog div -->
	<div id="modal_zipAddress" style="width: 500px;"></div>
</body>
</html>
<script>
	/* 로그인 ID */
	let loginId = getSigninAccount().accountId;
	$('#registerId').val(loginId)
	//시설 ID
	let id = getParameter("id");

	function addressModal() {
		var element_wrap = document.getElementById("modal_zipAddress");
		
		new daum.Postcode({
			oncomplete:function(data) {
				jQuery("#zip").val(data.zonecode);
				jQuery("#lmnAdres1").val(data.autoJibunAddress);
				$('[name=rnAdres1]').val(data.address);
				jQuery("#adres2").focus();
			}
			, onclose:function(state) {
				$("#modal_zipAddress").dialog("close");
			} 
		}).embed(element_wrap);

		$("#modal_zipAddress").dialog({
			autoOpen: true,
			width: "550px",
			modal: true,
			show:{
				effect: "build"
			}
		});
	}

	$(document).ready(function() {
        $.ajax({
			type: "GET",
			url: global.apiUrl+"/cmDsnfFclties/"+id,
			async: false,
			//data: JSON.stringify(formData),
			contentType: "application/json",
			dataType: 'json',
			success: function (res) {
				console.log(res)
				$('#nm').val(res.nm);
				$('#registDt').val(res.registDt);
				//차량분류 
				//공통영역에서 번역해 가지고 오기.
				$('#area').val(res.area);
				$('#status').val(res.status);
				$('#ty').val(res.ty);
				$('#rnAdres1').val(res.rnAdres1);
				$('#adres2').val(res.adres2);
				$('#zip').val(res.zip);
			}, 
			complete: function (res) {
				//담당공무원 list
				$.ajax({
					url: global.apiUrl+"/cmDsnfFclties/"+id+"/chrgPbsvnts",
					type: "GET",
					cache: false,
					dataType: "json",
					
					success: function(data) {
						var chrgPbsvnts = data._embedded.accountDetails;
						var makeChrgPbsvntsHtml = "";
						console.log("chrgPbsvnts",chrgPbsvnts)
						for(i=0; i<chrgPbsvnts.length; i++){
							makeChrgPbsvntsHtml += "<tr><td>" + chrgPbsvnts[i].seq + "</td>";
							makeChrgPbsvntsHtml += "<td>" + chrgPbsvnts[i].position + "</td>";
							makeChrgPbsvntsHtml += "<td>" + chrgPbsvnts[i].clsf + "</td>";
							makeChrgPbsvntsHtml += "<td>" + chrgPbsvnts[i].name + "</td>";
							makeChrgPbsvntsHtml += "<td>" + chrgPbsvnts[i].accountId + "</td>";
							makeChrgPbsvntsHtml += "<td>" + chrgPbsvnts[i].mobile + "</td>";
							makeChrgPbsvntsHtml += "<td>" + chrgPbsvnts[i].isUsable + "</td>";
							makeChrgPbsvntsHtml += "<td>" + chrgPbsvnts[i].createdAt + "</td>";
							makeChrgPbsvntsHtml += "<td><button type='button' class='btn-td-delete' onclick='deleteChrgPbsvnts(`"+chrgPbsvnts[i].accountId+"`)'>삭제</button></td></tr>";
						}
						document.getElementById('chrgPbsvnts').innerHTML=makeChrgPbsvntsHtml;
					},   
					error: function (request, status, error){
						var msg = "ERROR<br><br>"
						msg += request.status + "<br>" + request.responseText + "<br>" + error;
						console.log(msg);                    
					}
				});
			},
			error: function (request, status, error){
				var msg = "ERROR<br><br>"
				msg += request.status + "<br>" + request.responseText + "<br>" + error;
				console.log(msg);
			}
		});

	});
	function deleteChrgPbsvnts(account) {

		var g = confirm("삭제 하시겠습니까?");
		//담당공무원 삭제
		if(g){
			$.ajax({
				url: global.apiUrl+"/cmDsnfFclties/"+id+"/chrgPbsvnts/"+account+"/delete",
				type: "DELETE",
				cache: false,
				dataType: "json",
				
				success: function(data) {
					alert("삭제 되었습니다.")
				},   
				error: function (request, status, error){
					var msg = "ERROR<br><br>"
					msg += request.status + "<br>" + request.responseText + "<br>" + error;
					console.log(msg);                    
				}
			});
		}
	}

	$(function(){
		$("#updateDisinfectionFacilities").validate({
			//validation이 끝난 이후의 submit 직전 추가 작업할 부분
			submitHandler: function(form, event) {
				event.preventDefault(); //form 의 submit 을 막고 ajax 로 동작하기 위한 구문
				var tempArray = $(form).serializeArray();
				var formData = {}
				for(i=0; i<tempArray.length; i++){
					formData[tempArray[i].name] =  tempArray[i].value;
				}
				var f = confirm("수정하시겠습니까?");
				if(f){
					$.ajax({
						type: 'PUT',
						url: global.apiUrl+"/cmDsnfFclties/"+id+"/update",
						async: false,
						data: JSON.stringify(formData),
						contentType: "application/json",
						dataType: 'json',
						success: function (res) {
							alert("수정되었습니다.")	;
						}, 
						complete: function (res) {
							window.location.href="./disinfectionFacilitiesList.html"
						},
						error: function(err) {
							alert("실패");
						}
					});
					return false;
				} else {
					return false;
				}
			},
			//규칙
			rules: {
				rnAdres1: {
					required : true,
					minlength : 5,
					//remote: "/check_id.jsp"
				},
				/* adres2: {
					required : true,
					minlength : 3
				}, */
				area: {
					required : true,
					//minlength : 3,
					//equalTo : password
				},
				nm: {
					required : true,
					minlength : 2
				},
				registerId: {
					required : true,
					//digits : true // 숫자만 입력
				},
				status: {
					required : true,
					//minlength : 2
				},
				ty: {
					required : true,
					//minlength : 2
				},
				zip: {
					required : true,
					minlength : 2
				}
			},
			//규칙체크 실패시 출력될 메시지
			messages : {
				rnAdres1: {
					required : "필수로입력하세요",
					minlength : "최소 {0}글자이상이어야 합니다",
				},
				/* adres2: {
					required : "필수로입력하세요",
					minlength : "최소 {0}글자이상이어야 합니다"
				}, */
				area: {
					required : "필수로입력하세요",
					minlength : "최소 {0}글자이상이어야 합니다",
				},
				nm: {
					required : "필수로입력하세요",
					minlength : "최소 {0}글자이상이어야 합니다"
				},
				registerId: {
					required : "필수로입력하세요",
				},
				status: {
					required : "필수로입력하세요",
					minlength : "최소 {0}글자이상이어야 합니다",
				},
				ty: {
					required : "필수로입력하세요",
					minlength : "최소 {0}글자이상이어야 합니다",
				},
				zip: {
					required : "필수로입력하세요",
					minlength : "최소 {0}글자이상이어야 합니다",
				}
			}
		});
	});
	$("#headers").load("../common/headers.html");
	$("#gnb").load("../common/gnb.html");
	
	//목록으로 이동
	function menuListBack(){
		window.location.href="disinfectionFacilitiesList.html";
	}

	
</script>