<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>거점소독시설 관리자 사이트</title>
	<link rel="stylesheet" href="../assets/css/common.css">
	<link rel="stylesheet" href="../assets/css/fonts.css">
	<link rel="stylesheet" href="../assets/css/jquery-ui.css">
	<link rel="stylesheet" href="../assets/css/jquery-ui-1.11.0.css">
	<link rel="stylesheet" href="../assets/css/style.css">
	<script type="text/javascript" src="../assets/js/jquery-3.4.1.min.js"></script>
	<script type="text/javascript" src="../assets/js/jquery-ui.min.js"></script>
	<script type="text/javascript" src="../assets/js/jquery.mCustomScrollbar.min.js"></script>
	<script type="text/javascript" src="../assets/js/custom.js"></script>
	<script type="text/javascript" src="../../assets/js/comm.js"></script>
	<script type="text/javascript" src="../assets/js/excelexportjs.js"></script>
	<!-- jquery DataTable script 시작 -->
	<link rel="stylesheet" href="../assets/css/tableData.css">
	<script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
	<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>
	<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script>
	<!-- jquery DataTable script 끝 -->
	<!-- Data format 시작 -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
	<!-- Data format 끝-->
</head>
<body>
	<div class="header">
		<!-- TOP SECTION -->
		<div id="headers"></div>
		<!-- //TOP SECTION -->
		<!-- GNB SECTION -->
		<div id="gnb"></div>
		<!-- //GNB SECTION -->
		<!-- contents -->
		<div class="contents clearfix" id="contents">
			<div class="lnb-wrap">
				<h2 class="lnb-tit"><span>사용자 관리</span></h2>
				<ul class="lnb-menu">
					<li class="on">
						<a href="usersList.html">사용자 현황</a>
						<ul>
							<li><a href="usersAdd.html">사용자 등록</a></li>
						</ul>
					</li>                 
				</ul>
			</div>
			<div class="contents-inn">
				<h3 class="page-tit"><span>사용자 현황</span></h3>
				<div class="search-condition-box clearfix">
					<!-- <div class="search-condition-tit">검색조건</div> -->
					<table class="tb-modal-option">
						<tr>
							<th>기간 선택</th>
							<td class="condition-input-box">
								<div class="input-datepicker-box">
									<span class="icon-calender"><img src="../assets/images/ico-date.png" alt="날짜 선택" title="날짜 선택"></span>
									<input type="text" id="datepickerStart" class="input-datepicker">
								</div>
								<div class="ico-wave">
									~
								</div>
								<div class="input-datepicker-box">
									<span class="icon-calender"><img src="../assets/images/ico-date.png" alt="날짜 선택" title="날짜 선택"></span>
									<input type="text" id="datepickerEnd" class="input-datepicker">
								</div>
							</td>
							<th>사용자 유형</th>
							<td class="condition-input-box">
								<select id="accountTy" name="accountTy">                    
									<option value="" selected="">사용자 유형</option>                    
									<option value="STKRS_VHCLE_DRVER">축산차량 운전자</option>                 
									<option value="STKRS_FCLTY_CHARGER">시설 관리자</option>       
								</select>
							</td>                        
						</tr>
						<tr>                          
							<th>승인 상태</th>
							<td class="condition-input-box">
								<select id="status" name="status" class="">                    
									<option value="" selected="">사용자 상태</option>                    
									<option value="SBSCRB_COMPT">가입완료</option>                                     
									<option value="CONFM_REJECT">승인거절</option>
									<option value="CONFM_COMPT">승인완료</option>
								</select>
							</td>
							<th>아이디 검색</th>
							<td class="condition-input-box">
								<div class="text-box">
									<input type="text" id="accountId" name="accountId" placeholder="아이디">
								</div>
							</td> 
						</tr>
					</table>  
					<div class="btn-search-condition-box">
						<button class="btn-search" onclick="searchFunction();"><span class="icon-search"><img src="../assets/images/ico-search.png" alt="검색"></span>검색</button>
					</div>                 
				</div>               
				<div class="tb-wrap">
					<h4 class="tb-tit"><span class="icon-bullet"><img src="../assets/images/bullet1.png" alt="테이블 제목"></span>사용자 목록</h4>
					<div class="btn-add-wrap">
						<button class="btn-add" id='DLtoExcel'>엑셀 다운로드</button>
						<button class="btn-add" onclick="location.href='usersAdd.html'"><span class="icon-add"><img src="../assets/images/icon-add.png" alt="등록하기"></span>사용자 등록하기</button>
					</div>
					<table class="tb-list" id="tableList">
						<!-- 승인상태 승인거절 : class="c-red" -->
						<!-- 승인상태 가입 완료 : class=" " -->
						<!-- 승인상태 승인 대기 : class="c-blue" -->
						<!-- 승인상태 승인 완료 : class="c-green" -->
						<thead>
							<tr>
								<th>사용자 유형</th>
								<th>이름</th>
								<th>ID</th>
								<!-- <th>이메일</th> -->
								<th>연락처</th>
								<th>가입일</th>
								<th>승인 상태</th>
							</tr>
						</thead>
					</table>
				</div>              
			</div>
		</div>
		<!-- //contents -->
	</div>
</body>
</html>
<script>
	$("#headers").load("../common/headers.html");
	$("#gnb").load("../common/gnb.html");
</script>

<script type="text/javascript">
	let draw = "";
	let totalPage = "";
	let table = "";
	$(document).ready(function() {
		tableList();

		var $btnDLtoExcel = $('#DLtoExcel');
		$btnDLtoExcel.on('click', function () {
			getExcelData();

			$("#dvjson").excelexportjs({
					containerid: "dvjson"
					, datatype: 'json'
					, dataset: excelData
					, columns: getColumns(excelData)     
			});

		});
	});
	//tableList function 
	function tableList(){
		
		let filter = "";
		let sum = "";
		filter+="&schColumns=status"+"&schKeywords=DELETE"+"&columnTypes=com.kware.dis.controller.dto.SignInAccount$STATUS"+"&columnFormats="+"&comparisonOperators=NEQ"+"&conditions=AND&size=10"
		/* filter+="&schColumns=createdAt"+"&schKeywords="+ "2020-09-03"+"&columnTypes=TIME"+"&columnFormats=YYYY-MM-DD"+"&comparisonOperators=GT"+"&conditions=AND"
		filter+="&schColumns=createdAt"+"&schKeywords="+ "2020-09-17"+"&columnTypes=TIME"+"&columnFormats=YYYY-MM-DD"+"&comparisonOperators=LT"+"&conditions=AND" */
		//useYn
		//기간검색 START
		if($('#datepickerStart').val() != ""){
			filter+="&schColumns=createdAt"+"&schKeywords="+ moment($('#datepickerStart').val()).format('YYYYMMDD 00:00:00.000000')+"&columnTypes=TIME"+"&columnFormats=yyyyMMdd%20HH:mm:ss.SSSSSS"+"&comparisonOperators=GT"+"&conditions=AND"
		}
		//기간 검색END 
		if($('#datepickerEnd').val() != ""){
			filter+="&schColumns=createdAt"+"&schKeywords="+ moment($('#datepickerEnd').val()).format('YYYYMMDD 00:00:00.000000')+"&columnTypes=TIME"+"&columnFormats=yyyyMMdd%20HH:mm:ss.SSSSSS"+"&comparisonOperators=LT"+"&conditions=AND"
		}
		/* 사용자 유형 */ //com.kware.dis.jpa.dis.domain.AccountDetail$ACCOUNT_TY
		if($('#accountTy').val() != ""){
			filter+="&schColumns=accountTy"+"&schKeywords="+ $('#accountTy').val()+"&columnTypes=com.kware.dis.jpa.dis.domain.AccountDetail$ACCOUNT_TY"+"&columnFormats="+"&comparisonOperators=EQ"+"&conditions=AND"
		}
		/* 계정 상태  */ 
		if($('#status').val() != ""){
			filter+="&schColumns=status"+"&schKeywords="+ $('#status').val()+"&columnTypes=com.kware.dis.controller.dto.SignInAccount$STATUS"+"&columnFormats="+"&comparisonOperators=EQ"+"&conditions=AND"
		} 
		/* ID 검색 */
		if($('#accountId').val() != ""){
			filter+="&schColumns=beaconUserId"+"&schKeywords="+ $('#accountId').val()+"&columnTypes=STRING"+"&columnFormats="+"&comparisonOperators=LK"+"&conditions=AND"
		}
		table =	$('#tableList').DataTable({
			//옵션
			"searching": false,
			"pagingType" : "full_numbers",
			"info" : true,
			"paging": true,
			"serverSide":true,
			"ordering" : true,
			"order": [[ 0, "desc" ]],
			//언어설정
			"language": 
			{   //"현재_START_ - _END_ / _TOTAL_개",
				"info": " _TOTAL_개/총개",
				"emptyTable" : "데이터가 존재하지 않습니다.",
				"sLengthMenu": "",
				"paginate": {
					"first": "맨앞",
					"next": "다음",
					"previous": "이전",
					"last": "맨끝"
				}
			},
			"ajax": {
				"type" : "GET",
				"url" : global.apiUrl+"/pweBeaconUserDetails/estnSearch?"+filter+sum,
				"data" : function(data){
					console.log("data",data)
					let page = "";
					let sort = "";
					page = "&page=" + parseInt(data.start/10);
					sort = "&sort=" + "createdAt,desc"
					if(data.order[0].dir == 'asc'){
						sort = "&sort=" + "createdAt,asc"
					}
					if(data.order[0].dir == 'desc') {
						sort = "&sort=" + "createdAt,desc"
					}
					draw = data.draw
					let sum = page + sort
					return sum
				},
				//data 명 바꾸기.
				'dataFilter': function(retData) {
					retData = JSON.parse(retData);  
					console.log("retData",retData)
					if(draw ==1){
						retData["recordsTotal"] = retData.page.totalElements;
						totalPage = retData.page.totalElements;
					}
					retData["recordsTotal"] = totalPage;
					retData["recordsFiltered"] =  retData.page.totalElements;
					retData["data"] =retData._embedded.pweBeaconUserDetails;

					return JSON.stringify(retData);
				},
				complete:function(data){
					document.getElementById('tableList_info').innerHTML=data.responseJSON.recordsFiltered+"개/총"+data.responseJSON.recordsTotal+"개"
				}
			},
			"columns": [
				{targets: 0, data: "accountTy",
				render : function(data,type,row){
						if(data == "POSITN_DSNF_FCLTY_MNGR"){
							data = "거점소독시설 담당자";
						}else if(data == "STKRS_VHCLE_DRVER"){
							data = "축산차량 운전자";
						}else{
							data = "농장(시설) 담당자";
						}
						return data;
					}

				},			//사용자 유형 */
				{targets: 1, data: "beaconUserNm"},			//이름
				{targets: 2, data: "beaconUserId"},			//ID
				//{targets: 3, data: "email" },				//이메일	
				{targets: 3, data: "beaconUserMbtlnum" },	//연락처
				{											//가입일
					targets: 4, data: "createdAt",
					render : function(data,type,row){
						if(data == null){
							data = "-";
						}else{
							data = moment(data).format('YYYY-MM-DD');
						}
						return data;
					}
				},
				{
					targets: 5, data: "status",				//승인상태
					render : function(data,type,row){
						if(data == 'SBSCRB_COMPT'){
							data = "가입완료";
						}else if(data == "CONFM_REJECT"){
							data = '승인거절';
						}else{
							data = '승인완료';
						}
						return data;
					},
					createdCell: function (td, cellData, rowData, row, col) {
						if ( cellData == 'SBSCRB_COMPT' ) {
							$(td).addClass('c-blue');
						} else if(cellData == 'CONFM_REJECT') {
							$(td).addClass('c-red');
						}else{
							$(td).addClass('c-green');
						}
					} 
				},		
			],

			//cell 데이터 변경
			"columnDefs":[],
			"dom":"lfrtBip",
			"buttons": [{
		/* 		extend: 'csvHtml5',
				text: '엑셀 다운로드',
				footer: true,
				className: 'exportBtn' */
			}],
		});  
	};

	function searchFunction(){
		//DataTable 초기화. 
		$('#tableList').DataTable().destroy();
		//DataTable 호출
		tableList();
	}
	$('#tableList').on('click', 'tr', function () {
		var data = table.row( this ).data();
		if(data !=undefined){
			window.location.href="usersView.html?id="+data.beaconUserId;
		}
	});
	
	function getExcelData(){
		$.ajax({
			type: "GET",
			url: global.apiUrl+"/pweBeaconUserDetails/estnSearch?"+filter,
	//		url: "http://localhost:8081/api1.0/cmStkrsFcltyInfoMs/disinfectionList",
			async: false,
			contentType: "application/json",
	//		dataType: "json",
			success: function(data){
				excelData=data._embedded.pweBeaconUserDetails;
			},
			error: function (request, status, error){
				alert("오류가..")
				console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error)
				//alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
			},
			complete: function(data){
			}
		})
	}
</script>