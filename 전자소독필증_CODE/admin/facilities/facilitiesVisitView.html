<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>거점소독시설 관리자 사이트</title>
	<link rel="stylesheet" href="../assets/css/common.css">
	<link rel="stylesheet" href="../assets/css/fonts.css">
	<link rel="stylesheet" href="../assets/css/jquery-ui.css">
	<link rel="stylesheet" href="../assets/css/jquery-ui-1.11.0.css">
	<link rel="stylesheet" href="../assets/css/style.css">
	<script src="../assets/js/jquery-3.4.1.min.js"></script>
	<script src="../assets/js/jquery-ui.min.js"></script>
	<script src="../assets/js/jquery.mCustomScrollbar.min.js"></script>
	<script src="../assets/js/custom.js"></script>
	<script type="text/javascript" src="../../assets/js/comm.js"></script>
	<!-- Data format 시작 -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
	<!-- Data format 끝-->
</head>
<body>
	<div class="header">
	
		<!-- TOP SECTION -->
		<div id="headers"></div>
		<!-- //TOP SECTION -->
		<!-- GNB SECTION -->
		<div id="gnb"></div>
		<!-- //GNB SECTION -->  
		<!-- contents -->
		<div class="contents clearfix" id="contents">
			<div class="lnb-wrap">
				<h2 class="lnb-tit"><span>시설 등록</span></h2>
				<ul class="lnb-menu">
					<li>
						<a href="facilitiesList.html">시설 현황</a>
						<ul>
							<li><a href="facilitiesAdd.html">시설 등록</a></li>
						</ul>
					</li> 
					<li class="on">
						<a href="facilitiesVisitList.html">방문 현황</a>
					</li>                   
				</ul>
			</div>
			<div class="contents-inn">
				<h3 class="page-tit"><span>방문 현황 상세보기</span></h3>
				<div class="tb-summary-wrap">
					<table>
						<div class="tb-datetime-box">
							<span class="tb-datetime" id="currentTime"></span>
						</div>                        
						<tbody>
							<tr>
								<th>방문 승인 건</th>
								<td id="visitConfirm"></td>
								<th>방문 거절 건</th>
								<td id="visitReject"></td>
							</tr>
						</tbody>
					</table>
				</div>  
				<div class="tb-wrap Add">
					<h4 class="tb-tit"><span class="icon-bullet"><img src="../assets/images/bullet1.png" alt="테이블 제목"></span>시설 기본정보</h4>
					<table class="tb-view">                        
						<tbody>
							<tr>
								<th><span class="mark-essential">*</span>시설 명</th>
								<td colspan="3" id="nm"></td>                               
							</tr>
							<tr>
								<th><span class="mark-essential">*</span>등록일</th>
								<td id="fcltyRegistde"></td>
								<th><span class="mark-essential">*</span>시설 코드</th>
								<td id="fcltyCode"></td>
							</tr>
							<tr>
								<th><span class="mark-essential">*</span>시설 지역</th>
								<td id="area"></td>
								<th><span class="mark-essential">*</span>축종</th>
								<td id="ty"></td>                         
							</tr>
							<tr>
								<th><span class="mark-essential">*</span>시설 소재지</th>
								<td id="adres2"></td>
								<th><span class="mark-essential">*</span>운영 상태</th>
								<td id="status"></td>
							</tr>
						</tbody>
					</table>
				</div> 
				<div class="tb-wrap Add">
					<h4 class="tb-tit"><span class="icon-bullet"><img src="../assets/images/bullet1.png" alt="테이블 제목"></span>구제역 정보</h4>
					<table class="tb-view">                        
						<tbody>
							<tr>
								<th><span class="mark-essential">*</span>구제역 이동제한 시설</th>
								<td id="fmdMvmnLmtt"></td>
								<th><span class="mark-essential">*</span>등록일</th>
								<td id="fmdMvmnLmttDt"></td>                              
							</tr>
						</tbody>
					</table>
				</div> 
				<div class="tb-wrap Add">
					<h4 class="tb-tit"><span class="icon-bullet"><img src="../assets/images/bullet1.png" alt="테이블 제목"></span>소유주 정보</h4>
					<table class="tb-view">                        
						<tbody>
							<tr>
								<th><span class="mark-essential">*</span>소유주 명</th>
								<td id="ownerNm"></td> 
								<th><span class="mark-essential">*</span>소유주 연락처</th>
								<td id="ownerCttpc"></td>  
								<th><span class="mark-essential">*</span>소유주 주소</th>
								<td id= "ownerAdres"></td>                               
							</tr>
						</tbody>
					</table>
				</div> 
				<div class="tb-wrap Add">
					<h4 class="tb-tit"><span class="icon-bullet"><img src="../assets/images/bullet1.png" alt="테이블 제목"></span>책임자 정보</h4>
					<table class="tb-view">                        
						<tbody>
							<tr>
								<th><span class="mark-essential">*</span>책임자 명</th>
								<td id="rspnberNm"></td>  
								<th><span class="mark-essential">*</span>책임자 연락처</th>
								<td id="rspnberCttpc"></td> 
								<th><span class="mark-essential">*</span>책임자 주소</th>
								<td id="rspnberAdres"></td>                                   
							</tr>
						</tbody>
					</table>
				</div>
				<div class="tb-wrap Add">
					<h4 class="tb-tit"><span class="icon-bullet"><img src="../assets/images/bullet1.png" alt="테이블 제목"></span>차량 정보</h4>
					<table class="tb-view">                        
						<tbody>
							<tr>
								<th><span class="mark-essential">*</span>법인 명</th>
								<td id="cprNm"></td>  
								<th><span class="mark-essential">*</span>사업자 등록 번호</th>
								<td id="bizrno"></td>  
								<th><span class="mark-essential">*</span>차량 번호</th>
								<td id="carNo"></td> 
							</tr>
							<tr>
								<th><span class="mark-essential">*</span>최대 적재량</th>
								<td id="mxmmLdadngQy"></td>
								<th><span class="mark-essential">*</span>차종</th>
								<td id="carTy"></td>                                   
								<th><span class="mark-essential">*</span>차량분류</th>
								<td id="carCl"></td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="tb-wrap">
					<h4 class="tb-tit"><span class="icon-bullet"><img src="../assets/images/bullet1.png" alt="테이블 제목"></span>시설근무자 정보</h4>
					<div class="btn-add-wrap">
						<button class="btn-add" onclick="location.href='../users/usersAdd.html'"><span class="icon-add"><img src="../assets/images/icon-add.png" alt="등록하기"></span>시설근무자 등록하기</button>
					</div>
					<table class="tb-view">   
						<thead>
							<th>No</th>
							<th>이름</th>
							<th>ID</th>
							<th>연락처</th>
							<th>근무상태</th>
							<th>가입일</th>
						</thead>                     
						<tbody id="chrgManList"></tbody>
					</table>
				</div> 
				<div class="btn-tbView-box">
					<button class="btn-list" type="button" onclick="location.href='./facilitiesVisitList.html'"><span class="icon-list"><img src="../assets/images/icon-list.png" alt="목록"></span>목록</button>
				</div>               
			</div>
		</div>
		<!-- //contents -->
	</div>
</body>
</html>
<script type="text/javascript">
	$("#headers").load("../common/headers.html");
	$("#gnb").load("../common/gnb.html");
	let id = getParameter("id");
	currentTime();
	$(document).ready(function(){
		$.ajax({
			url: global.apiUrl+"/visitHistories/"+id,
			type: "GET",
			cache: false,
			dataType: "json",
			success: function(data){
				console.log("최초 데이터",data)
				console.log("link",data._links.cmFarmInfoM.href)
				var today = new Date(); 
				var tomorrow = new Date(today.valueOf() + (24*60*60*1000)); var year = tomorrow.getFullYear(); 
				//방문
				let registDt = "";
				registDt+="&schColumns=registDt"+"&schKeywords="+moment(today).format('YYYYMMDD 00:00:00.000000') +"&columnTypes=TIME"+"&columnFormats=yyyyMMdd%20HH:mm:ss.SSSSSS"+"&comparisonOperators=GT"+"&conditions=AND"
				registDt+="&schColumns=registDt"+"&schKeywords="+moment(tomorrow).format('YYYYMMDD 23:59:59.000999') +"&columnTypes=TIME"+"&columnFormats=yyyyMMdd%20HH:mm:ss.SSSSSS"+"&comparisonOperators=LT"+"&conditions=AND"
				$.ajax({
					url : global.apiUrl+"/visitHistories/countBy?"+registDt+ getEstnUrl("farmNo", data.animalHusbandryFacilityId ,"STRING", "EQ")+ getEstnUrl("visitConfmAt","true","BOOLEAN","EQ"),
					type: "GET",
					cache: false,
					dataType: "json",
					success: function(data){

						$("#visitConfirm").html(data.page.totalElements)
					}
				})
				//미방문
				$.ajax({
					url : global.apiUrl+"/visitHistories/countBy?"+registDt+ getEstnUrl("farmNo", data.animalHusbandryFacilityId ,"STRING", "EQ")+ getEstnUrl("visitConfmAt","false","BOOLEAN","EQ"),
					type: "GET",
					cache: false,
					dataType: "json",
					success: function(data){
						console.log(data)
						$("#visitReject").html(data.page.totalElements)
					}
				})
				$.ajax({
					url: data._links.cmFarmInfoM.href,
					type: "GET",
					cache: false,
					dataType: "json",
					success: function(data){
						console.log("시설정보")
						console.log(data)
						$('#nm').html(data.nm);
						$('#fcltyRegistde').html(moment(data.registDt).format('YYYY-MM-DD'));
						$('#fcltyCode').html(data.fcltyCode)
						//공통영역에서 번역해 가지고 오기.
						$('#area').html(areaTranslation(data.area));
						$('#adres2').html(data.zip+") "+data.rnAdres1 + data.adres2);
						$('#status').html(statusTranslation(data.status));
						$('#ty').html(facilitiesTranslation(data.ty));
						if(data.fmdMvmnLmtt==true){
							$("#fmdMvmnLmtt").html("이동제한");
						} else if(data.fmdMvmnLmtt==false) {
							$("#fmdMvmnLmtt").html("이동제한 해제");
						}
						$('#fmdMvmnLmttDt').html(data.fmdMvmnLmttDt);
						$('#ownerNm').html(data.ownerNm);
						$('#ownerCttpc').html(data.ownerCttpc);
						$('#ownerAdres').html(data.ownerZip+") "+data.ownerAdres1 + data.ownerAdres2);
						$('#rspnberNm').html(data.rspnberNm);
						$('#rspnberCttpc').html(data.rspnberCttpc);
						$('#rspnberAdres').html(data.rspnberZip+") "+data.rspnberAdres1 + data.rspnberAdres2);
						//시설근무자 정보
						$.ajax({
							url: data._links.chrgManList.href,
							type: "GET",
							cache: false,
							dataType: "json",
							success: function(data){
								if(data._embedded.pweBeaconUserDetails.length!=0) {
									for(i=0; i<data._embedded.pweBeaconUserDetails.length; i++) {
										var chrgMan ="<tr>"
											chrgMan += "<td>"+(i+1)+"</td>";
											chrgMan += "<td>"+data._embedded.pweBeaconUserDetails[i].beaconUserNm+"</td>";
											chrgMan += "<td>"+data._embedded.pweBeaconUserDetails[i].beaconUserId+"</td>";
											chrgMan += "<td>"+data._embedded.pweBeaconUserDetails[i].beaconUserMbtlnum+"</td>";
											chrgMan += "<td>"+accountStatusTranslation(data._embedded.pweBeaconUserDetails[i].status)+"</td>";
											chrgMan += "<td>"+moment(data._embedded.pweBeaconUserDetails[i].createdAt).format('YYYY-MM-DD')+"</td>";
											chrgMan +="</tr>"
											$("#chrgManList").append(chrgMan)
									}
								}
							}
						})
					},   
					error: function (request, status, error){
						var msg = "ERROR<br><br>"
						msg += request.status + "<br>" + request.responseText + "<br>" + error;
						console.log(msg);                    
					},
					complete: function(data){
						}
				});		
				$.ajax({
					url: data._links.car.href,
					type: "GET",
					cache: false,
					dataType: "json",
					success: function(data){
						console.log("차량정보")
						console.log(data)
						bizrno
						$("#cprNm").html(data.cprNm);
						$("#bizrno").html(data.bizrno);
						$("#carNo").html(data.carNo);
						$("#mxmmLdadngQy").html(data.mxmmLdadngQy);
						$("#carTy").html(data.carTy);
						$("#carCl").html(carClareaTranslation(data.carCl));
						
						
					},   
					error: function (request, status, error){
						var msg = "ERROR<br><br>"
						msg += request.status + "<br>" + request.responseText + "<br>" + error;
						console.log(msg);                    
					},
					complete: function(data){
					}
				});			
				console.log(data)
			},   
			error: function (request, status, error){
				var msg = "ERROR<br><br>"
				msg += request.status + "<br>" + request.responseText + "<br>" + error;
				console.log(msg);                    
			}
		});
	}); 
	//목록으로 이동
	function menuListBack(){
		window.location.href="facilitiesVisitList.html";
	}
	//수정 화면으로 이동
	function facilitiesUpdate(){
		window.location.href="facilitiesVisitUpdate.html?id="+id;
	}

	/* 삭제버튼 */
	function facilitiesDelete(){
		var f = confirm("삭제하시겠습니까?");
		let deleteData = {
			"status" : "DELETE"
		}
		if(f){
			$.ajax({
				type: 'PUT',
				url: global.apiUrl+"/visitHistories/"+id+"/update",
				async: false,
				data: JSON.stringify(deleteData),
				contentType: "application/json",
				dataType: 'json',
				success: function (res) {
					console.log("res",res)	
				}, 
				complete: function (res) {
					//window.location.href="./disinfectionList.html"
				},
				error: function(err) {
					alert("실패");
				}
			});
			return false;
		} else {
			return false;
		}

	}
</script>