<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>거점소독시설 관리자 사이트</title>
	<link rel="stylesheet" href="../assets/css/common.css">
	<link rel="stylesheet" href="../assets/css/fonts.css">
	<link rel="stylesheet" href="../assets/css/jquery-ui.css">
	<link rel="stylesheet" href="../assets/css/jquery-ui-1.11.0.css">
	<link rel="stylesheet" href="../assets/css/style.css">
	<script type="text/javascript" src="../assets/js/jquery-3.4.1.min.js"></script>
	<script type="text/javascript" src="../assets/js/jquery-ui.min.js"></script>
	<script type="text/javascript" src="../assets/js/jquery.mCustomScrollbar.min.js"></script>
	<script type="text/javascript" src="../assets/js/custom.js"></script>
	<!--주소검색 API-->
	<script type="text/javascript" src="http://dmaps.daum.net/map_js_init/postcode.v2.js"></script>
	<!--JQUERY modal-->
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script> -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />
	<!-- 공통 script -->
	<script type="text/javascript" src="../../assets/js/comm.js"></script>
	<!-- validate Check -->
	<script type="text/javascript" src="../assets/js/jquery.validate.min.js"></script>
	<script type="text/javascript" src="../assets/js/additional-methods.min.js"></script>
	<script type="text/javascript" src="../assets/js/messages_ko.min.js"></script>
	<!-- Data format 시작 -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
	<!-- Data format 끝-->
	
	<script type="text/javascript">
		let id=getParameter("id");
		let accounTy = "";
		//다음 api 호출
		function DsnfFcltyOnclick() {
			var element_wrap = document.getElementById("dsnfFcltyaAddr");
			
			new daum.Postcode({
				oncomplete:function(data) {
					$('#fclty_rnAdres1').val(data.roadAddress);
					$('#fclty_lmnAdres1').val(data.jibunAddress);
					
					$("#fclty_zip").val(data.zonecode);
					$("#fclty_userSelectedType").val(data.userSelectedType);
					$("#fclty_adres2").focus();
				}
				, onclose:function(state) {
					$("#dsnfFcltyaAddr").dialog("close");
				} 
			}).embed(element_wrap); 
			$("#dsnfFcltyaAddr").dialog({
				autoOpen: true,
				width: "550px",
				modal: true,
				show:{
					effect: "build"
				}
			});
		}
		$(document).ready(function(){
			$.ajax({
				url: global.apiUrl+"/accountDetails/search/findByAccountId?accountId="+id,
				type: "GET",
				cache: false,
				dataType: "json",
				success: function(data){
					console.log(data)
					accounTy = data.accountTy;
					$('#accountTy').html(accountTyTranslation(data.accountTy));
					$('#status').val(data.status);
					$('#accountId').html(data.accountId);
					$('#name').val(data.name);
					$('#createdAt').html(moment(data.createdAt).format('YYYY-MM-DD'));
					$('#moblphon').val(data.mobile);
					$('#email').val(data.email);
					$("#updusrId").val(data.accountId);
					$('#passwd').val(data.pass);
					$('#password_confirm').val(data.pass);
					if(data.sex=="F" ) {
						$('input:radio[name=sex]:input[value="FEMALE"]').attr("checked", true);
					} else  {
						$('input:radio[name=sex]:input[value="MALE"]').attr("checked", true);
					}
					$("#moblphonCertifity").val("1");
					if(data.accountTy== "POSITN_DSNF_FCLTY_MNGR"){
						$("#disInFection").show();
						$.ajax({
							url: global.apiUrl+"/cmDsnfFclties/search/findCmDsnfFcltyOfChrgPbsvnt?keyword="+id,
							type: "GET",
							cache: false,
							dataType: "json",
							success: function(data2){
								console.log("data2",data2)
								$('#fclty_nm').val(data2.nm)
								$('#fclty_area').val(data2.area)
								$('#fclty_rnAdres1').val(data2.rnAdres1)
								$('#fclty_lmnAdres1').val(data2.lmnAdres1)
								$('#fclty_adres2').val(data2.adres2)
								$('#fclty_status').val(data2.status)
								$('#fclty_zip').val(data2.zip)
								$('#fcltyId').val(data2.id)
								$('#position').val(data.position)
								$('#clsf').val(data.clsf)
								$('#workAreaNm').val(data.workAreaNm)
							},   
							error: function (request, status, error){  
								var msg = "ERROR<br><br>"
								msg += request.status + "<br>" + request.responseText + "<br>" + error;
								console.log(msg);
							}
						})
					}
				},   
				error: function (request, status, error){  
					var msg = "ERROR<br><br>"
					msg += request.status + "<br>" + request.responseText + "<br>" + error;
					console.log(msg);                    
				}
			});

		})
		/* 휴대폰 onChange 중복체크 초기화.*/
		function onChangeCkPhone(){
			$("#moblphonCertifity").val("");
		}
		/* 휴대폰 중복체크 */
		function moblphonCheck(){
			if($("#moblphon").val() == ""){
				alert("휴대폰 번호를 입력하세요.");
				return false;
			}
			if (!/(0[0-9]{1}[0-9]{1})([0-9]{3,4})([0-9]{4})$/.test($('#moblphon').val())){
				alert("다음과 같은 형식으로만 작성해 주세요.<br> ex) 01012345678 ");
				return false;
			}
			//거점소독 시설 관리자 일 경우
			$.ajax({
				url : global.apiUrl+"/accounts/countBy?&schColumns=mobile&schKeywords="+$("#moblphon").val()+"&columnTypes=STRING&columnFormats=&comparisonOperators=EQ&conditions=AND",
				type: "GET",
				cache: false,
				dataType: "json",
				success: function(data){
					if(data.page.totalElements >0){
						alert("중복된 휴대폰 번호 입니다.");
						return false;
					}else if(data.page.totalElements ==0){
						alert("사용 가능한 휴대폰 번호 입니다.");
						$("#moblphonCertifity").val("1");
					}
				}
			})
		}
		$(function(){
			$("#updateMember").validate({
				//validation이 끝난 이후의 submit 직전 추가 작업할 부분
				submitHandler: function(form, event) {
					event.preventDefault(); //form 의 submit 을 막고 ajax 로 동작하기 위한 구문
					if ($("#moblphonCertifity").val() == "") {
						alert("휴대폰 중복확인 후 회원가입 할 수 있습니다.")
						return false;
					}
					var formData = {};
					/* 공통 회원 추가 객체 */
					formData.accountTy = accounTy;
					formData.accountId = $("#accountId").html();
					formData.email = $("#email").val();
					formData.name = $("#name").val();
					formData.passwd = $("#passwd").val();
					formData.sexdstn = $("input[name=sex]:checked").val();
					formData.moblphon = $("#moblphon").val();
					/* 거점소독시설 관리자일 경우 */
					if(accounTy == "POSITN_DSNF_FCLTY_MNGR"){
						formData.position = $("#position").val();
						formData.clsf = $("#clsf").val();
						formData.workAreaNm = $("#workAreaNm").val();
						formData.cmDsnfFclty = {
							rnAdres1 : $("#fclty_rnAdres1").val(),
							lmnAdres1 : $("#fclty_lmnAdres1").val(),
							adres2 : $("#fclty_adres2").val(),
							area : $("#fclty_area").val(),
							nm : $("#fclty_nm").val(),
							updusrId : $("#accountId").html(),
							status : $("#fclty_status").val(),
							zip : $("#fclty_zip").val(),
							id : $("#fcltyId").val()
						};
					}
					var f = confirm("저장 하시겠습니까?");
					console.log("formData",formData)
					if(f){
						$.ajax({
							type: "PUT",
							url: global.apiUrl+"/members/update",
							async: false,
							contentType: "application/json",
							data: JSON.stringify(formData),
							dataType: 'json',
							success: function (res) {
								alert("수정을 완료 하였습니다.").
								window.location.href="./systemList.html"
							}, 
							error: function(err) {
								alert("실패");
							}
						});
						return false;
					} else {
						return false;
					}
				},
				//규칙
				rules: {
					status: {
						required : true
					},
					name: {
						required : true,
						minlength : 2
					},
					fclty_nm: {
						required : true,
					},
					fclty_area: {
						required : true
					},
					fclty_rnAdres1 : {
						required : true,
					},
					fclty_adres2 : {
						required : true
					},
					fclty_zip : {
						required : true
					},
					fclty_lmnAdres1 : {
						required : true
					},
					fclty_userSelectedType : {
						required : true
					},
					fclty_status : {
						required : true
					},
					position : {
						required : true
					},
					clsf : {
						required : true
					},
					workAreaNm : {
						required : true
					},
					passwd: {
						required: true,
						minlength: 8,
						maxlength: 20,
						passwordCk : true,
					},
					password_confirm: {
						required: true,
						minlength: 8,
						maxlength: 20,
						equalTo: "#passwd",
					},
				},
				//규칙체크 실패시 출력될 메시지
				messages : {
					status: {
						required : "필수로입력하세요"
					},
					name: {
						required : "필수로입력하세요",
						minlength : "최소 {0}글자이상이어야 합니다"
					},
					fclty_nm: {
						required : "필수로입력하세요"
					},
					fclty_area: {
						required : "필수로입력하세요"
					},
					fclty_rnAdres1 : {
						required : "필수로입력하세요"
					},
					fclty_adres2:{
						required : "필수로입력하세요"
					},
					fclty_zip : {
						required : "필수로입력하세요"
					},
					fclty_lmnAdres1 : {
						required : "필수로입력하세요"
					},
					fclty_userSelectedType : {
						required : "필수로입력하세요"
					},
					fclty_status : {
						required : "필수로입력하세요"
					},
					position : {
						required : "필수로입력하세요"
					},
					clsf : {
						required : "필수로입력하세요"
					},
					workAreaNm : {
						required : "필수로입력하세요"
					},
					passwd: {
						required: "필수로 입력하세요",
						minlength: "최소 {0}글자이상이어야 합니다",
						maxlength: "최대 {0}글자이하이어야 합니다",
						passwordCk : "비밀번호는 영문자,숫자,특수문자 조합을 입력해야 합니다."
					},
					password_confirm: {
						required: "필수로 입력하세요.",
						minlength: "최소 {0}글자이상이어야 합니다",
						maxlength: "최대 {0}글자이하이어야 합니다",
						equalTo: "비밀번호가 일치하지 않습니다.",
					},
				}
			});
			$.validator.addMethod("passwordCk",  function( value, element ) {
				return this.optional(element) ||  /^.*(?=.*\d)(?=.*[a-zA-Z])(?=.*[!@#$%^&+=]).*$/.test(value);
			});
		});
	</script>
</head>
<body>
	<div class="header">
	
		<!-- TOP SECTION -->
		<div id="headers"></div>
		<!-- //TOP SECTION -->
		<!-- GNB SECTION -->
		<div id="gnb"></div>
		<!-- //GNB SECTION -->   
		<!-- contents -->
		<div class="contents clearfix" id="contents">
			<div class="lnb-wrap">
				<h2 class="lnb-tit"><span>관리자 관리</span></h2>
				<ul class="lnb-menu">
					<li class="on">
						<a href="systemList.html">관리자 현황</a>
						<ul>
							<li><a href="systemAdd.html">관리자 등록</a></li>
						</ul>
					</li>
				</ul>
			</div>
			<form id="updateMember" method="PUT">   
				<div class="contents-inn">
					<div class="tb-wrap Add">
						<h3 class="page-tit"><span>관리자 수정</span></h3>
						<div class="tb-wrap Add">
							<table class="tb-list">
								<tbody>
									<tr>
										<th><span class="mark-essential">*</span>관리자 유형</th>
										<td id="accountTy"></td>
										<th><span class="mark-essential">*</span>관리자 명</th>
										<td class="condition-input-box">
											<div class="text-box">
												<input type="text" class="condition search" id="name" name="name">
											</div>
										</td> 
									</tr> 
									<tr>
										<th><span class="mark-essential">*</span>ID</th>
										<td id="accountId"></td>
										<th><span class="mark-essential">*</span>연락처</th>
										<td class="condition-input-box">
											<div class="text-box">
												<input type="text" id="moblphon" name="moblphon" placeholder="'-'은 생략해주세요." onchange="onChangeCkPhone();">
												<button class="btn-td-search" type="button" onclick="moblphonCheck();">중복확인</button>
												<input type="hidden" id="moblphonCertifity">
											</div>
										</td>
									</tr>
									<tr>
										<th><span class="mark-essential">*</span>비밀번호</th>
										<td class="condition-input-box">
											<div class="text-box">
												<input type="password" name="passwd" id="passwd" placeholder="비밀번호">
											</div>
										</td>
										<th><span class="mark-essential">*</span>비밀번호 재입력</th>
										<td class="condition-input-box">
											<div class="text-box">
												<input type="password" name="password_confirm" id="password_confirm" placeholder="비밀번호 재입력">
											</div>
										</td> 
									</tr>
									<tr>
										<th><span class="mark-essential">*</span>이메일</th>
										<td class="condition-input-box">
											<div class="text-box">
												<input type="text" id="email" name="email" placeholder="이메일주소">
											</div>
										</td>
										<th><span class="mark-essential">*</span>등록일</th>
										<td id="createdAt"></td>
									</tr>
									<tr>
										<th><span class="mark-essential">*</span>계정 상태</th>
										<td class="condition-input-box">
											<select id="status" name="status" class="">                    
												<option value="" selected="">계정 상태</option>                    
												<option value="NRMLT">정상</option>                    
												<option value="DRMNCY">휴면</option>                    
												<option value="STOP">정지</option>                  
											</select>
										</td>
										<th><span class="mark-essential">*</span>성별</th>
										<td class="condition-input-box">
											<label class="container radio">남자
												<input type="radio" checked="checked" name="sex" value="MALE">
												<span class="checkmark"></span>
											</label>                                      
											<label class="container radio">여자
												<input type="radio" name="sex" value="FEMALE">
												<span class="checkmark"></span>
											</label>
										</td> 
										<input type="hidden" id="updusrId" name="updusrId">
									</tr>
								</tbody>
							</table>
						</div>
						<!-- 거점소독 관리자 DIV -->
						<!-- 거점소독 시설 관리자 등록 -->
						<div class="tb-wrap Add" id="disInFection" style="display:none;">
							<h4 class="tb-tit"><span class="icon-bullet"><img src="../assets/images/bullet1.png" alt="테이블 제목"></span>사용자 거점소독시설 정보</h4>
							<table>
								<tbody>
									<tr>
										<th><span class="mark-essential">*</span>시설 명</th>
										<td class="condition-input-box">
											<div class="text-box">
												<input type="text" id="fclty_nm" name="fclty_nm">
												<input type="hidden" id="fcltyId" name="fcltyId">
											</div>
										</td>
										<th><span class="mark-essential">*</span>시설 지역</th>
										<td class="condition-input-box">
											<div class="text-box">
												<select  id="fclty_area" name="fclty_area"  class="">
													<option value="" selected="">지역선택</option>
													<option value="SU">서울</option>
													<option value="GG">경기</option>
													<option value="IC">인천</option>
													<option value="BS">부산</option>
													<option value="DG">대구</option>
													<option value="GJ">광주</option>
													<option value="DJ">대전</option>
													<option value="US">울산</option>
													<option value="SJ">세종</option>
													<option value="GW">강원</option>
													<option value="GN">경남</option>
													<option value="GB">경북</option>
													<option value="JN">전남</option>
													<option value="JNBK">전북</option>
													<option value="CHN">충남</option>
													<option value="CB">충북</option>
													<option value="JJ">제주</option>
												</select>
											</div>
										</td>
										<th><span class="mark-essential">*</span>거점소독시설 주소</th>
										<td class="condition-input-box">
											<div class="search-box">
												<input type="text" name="fclty_rnAdres1" id="fclty_rnAdres1" placeholder="시설 주소" readonly>
												<button class="btn-td-search" type="button" onclick="DsnfFcltyOnclick();">검색</button>
												<input type="text" name="fclty_adres2" id="fclty_adres2" placeholder="시설 상세주소">
												<input type="hidden" name="fclty_zip"  id="fclty_zip" placeholder="시설 우편주소">
												<input type="hidden" name="fclty_lmnAdres1"  id="fclty_lmnAdres1" placeholder="시설 지번주소">
												<input type="hidden" name="fclty_userSelectedType" id="fclty_userSelectedType" placeholder="도로명/지역 구분코드">
											</div>
										</td>
										<th><span class="mark-essential">*</span>운영상태</th>
										<td class="condition-input-box">
											<div class="search-box">
												<select id="fclty_status" name="fclty_status">
													<option value="" selected="">운영상태</option>
													<option value="NRMLT">정상</option>
													<option value="WAIT">대기</option>
													<option value="EMGNC">비상</option>
													<option value="CLS">폐쇄</option>
												</select>
											</div>
										</td>
									</tr>
									<tr>
										<th><span class="mark-essential">*</span>소속</th>
										<td class="condition-input-box">
											<div class="text-box">
												<input type="text" id="position" name="position">
											</div>
										</td>
										<th><span class="mark-essential">*</span>직급</th>
										<td class="condition-input-box">
											<div class="text-box">
												<input type="text" id="clsf" name="clsf">
											</div>
										</td>
										<th><span class="mark-essential">*</span>근무지 명</th>
										<td class="condition-input-box" colspan="3">
											<div class="text-box">
												<input type="text" name="workAreaNm" id="workAreaNm" >
											</div>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
						<div class="btn-tbView-box">
							<button class="btn-save"><span class="icon-save"><img src="../assets/images/icon-save.png" alt="저장"></span>저장</button>
							<button class="btn-list"><span class="icon-list"><img src="../assets/images/icon-list.png" alt="목록"></span>목록</button>
						</div>
					</div>
				<!-- //contents -->
				</div>
			</form>
		<div id="dsnfFcltyaAddr" style="width: 500px;"></div>
		</div>
	</div>
</body>
</html>
<script>
	$("#headers").load("../common/headers.html");
	$("#gnb").load("../common/gnb.html");
</script>