<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>거점소독시설</title>
	<link rel="stylesheet" href="../assets/css/common.css">
	<link rel="stylesheet" href="../assets/css/style.css">
	<script type="text/javascript" src="../assets/js/jquery-3.4.1.min.js"></script>
	<script type="text/javascript" src="../assets/js/jquery-ui.min.js"></script>
	<script type="text/javascript" src="../assets/js/custom.js"></script>
	<script type="text/javascript" src="../../assets/js/comm.js"></script>
	<script type="text/javascript" src="../../assets/js/conditionModal.js"></script>
	<!-- Data format-->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
	<!-- sessionChk -->
	<script type="text/javascript" src="../../assets/js/sessionChk.js"></script>
	<script type="text/javascript">
		var loginUserFcltySeq=getSigninAccount().orgId;
		//발급승인 목록
		var issuCurrentPage = 0;			//발급승인목록 현재 페이지
		var issuCountPerPage = 10;			//발급승인목록 페이지 당 갯수
		var issuTotal = 0;					//발급승인목록 총 갯수

		var defaultIssuUrl = global.apiUrl+"/elctrnDsnfCerfins/estnSearch?"
					+ getEstnUrl("issuDsnfFcltyId",loginUserFcltySeq,"NUMBER","EQ") 
					+ getEstnUrl("status","ISSU","com.kware.dis.jpa.dis.domain.ElctrnDsnfCerfin$Status","EQ") 
					+ "&sort=id,desc";

		//발급거절 목록
		var rejectCurrentPage = 0;           //발급거절목록 현재 페이지
		var rejectCountPerPage = 10;          //발급거절목록 페이지 당 갯수
		var rejectTotal = 0;                 //발급거절목록 총 갯수

		var defaultRejectUrl = global.apiUrl+"/elctrnDsnfCerfins/estnSearch?"
					+ getEstnUrl("issuDsnfFcltyId", loginUserFcltySeq,"NUMBER","EQ") 
					+ getEstnUrl("status","ISSU_REJECT","com.kware.dis.jpa.dis.domain.ElctrnDsnfCerfin$Status","EQ") 
					+ "&sort=id,desc";

		//검색조건 전역변수
		var filterIssu = "";
		var filterReject = "";

		var tempSampleIssueList;
		var sampleIssueList;

		var tempSampleRejectList;
		var sampleRejectList;

		$(document).ready(function() {
			//session Check localStorage에 accountId 없을 경우 login Page로 이동
			sessionChk();
			
			tempSampleIssueList = $('.sampleIssueList');
			sampleIssueList = tempSampleIssueList.clone();
			tempSampleIssueList.css("display", "none");
	
			tempSampleRejectList = $('.sampleRejectList');
			sampleRejectList = tempSampleRejectList.clone();
			tempSampleRejectList.css("display", "none");
	
			function back(){
				window.history.back();
			}

			getIssuTotalPage();
			getRejectTotalPage();

			getIssuList();
			getRejectList();

			var getMyListSearch = function(estnSearchUrlIssu, estnSearchUrlReject) {
				$("#issuUl").empty();
				$("#rejectUl").empty();
				
				filterIssu = "";
				filterReject = "";

				//페이징 초기화
				issuTotal = 0;
				rejectTotal = 0;
				issuCurrentPage = 0;
				rejectCurrentPage=0;
				

				if(estnSearchUrlIssu != null && estnSearchUrlIssu != undefined) {
					filterIssu=estnSearchUrlIssu;
				}

				if(estnSearchUrlReject != null && estnSearchUrlReject != undefined) {
					filterReject=estnSearchUrlReject;
				}

				getIssuTotalPage(filterIssu);
				getRejectTotalPage(filterReject);

				getIssuList(filterIssu);
				getRejectList(filterReject);
				
			}

			$(window).scroll(function () {
				if($(window).scrollTop()-1 < $(document).height() - $(window).height() && $(window).scrollTop()+1 > $(document).height() - $(window).height()) {
					if($(".on")[0]==$(".on").parent().children()[0]) { //발급승인 목록이 선택되었을 경우
						getIssuList(filterIssu);
						issuCurrentPage++;					
					} else if($(".on")[0]==$(".on").parent().children()[1]) {   //발급거절 목록이 선택되었을 경우				
						getRejectList(filterReject);
						rejectCurrentPage++;
					}
					
				}
			});
			const searchValue=document.getElementById('searchBox');
			//const searchValue=document.querySelector('input[type="search"]');
			const fromDateValue=$('#fromDateValue');
			const toDateValue=$('#toDateValue');
			const orderValue=$('#orderValue');

			$('#btn-condition').click(function() {
				makeConditionModal(searchValue, fromDateValue, toDateValue, orderValue, getMyListSearch);
			})

		})

		function getIssuTotalPage(searchUrl) {
			var url;
			if(searchUrl!=undefined){
				url=defaultIssuUrl+searchUrl
			} else {
				url=defaultIssuUrl;
			}
			$.ajax({
				type: 'GET',
				url: url,
				async: false,
				contentType: "application/json",
				dataType: 'json',
				success: function (res) {
					issuTotal=res.page.totalElements;
				}, 
				complete: function (res) {
					//window.location.href="./disinfectionList.html"
				},
				error: function(err) {
					//alert("실패");
				}
			});
		}

		function getRejectTotalPage(searchUrl) {
			var url;
			if(searchUrl!=undefined){
				url=defaultRejectUrl+searchUrl
			} else {
				url=defaultRejectUrl;
			}
			$.ajax({
				type: 'GET',
				url: url,
				async: false,
				contentType: "application/json",
				dataType: 'json',
				success: function (res) {
					rejectTotal=res.page.totalElements;
				}, 
				complete: function (res) {
					//window.location.href="./disinfectionList.html"
				},
				error: function(err) {
					//alert("실패");
				}
			});
		}

		function countIssuPage() {
			var pageUrl;
			if ( issuTotal==0 ) {
				pageUrl="MAX";
			} else if( issuTotal > issuCurrentPage*issuCountPerPage) {
				pageUrl="&page="+issuCurrentPage+"&size=10";
				issuCurrentPage++;
			} else if ( issuTotal <= issuCurrentPage*issuCountPerPage ) {
				pageUrl="MAX";
			}
			return pageUrl;
		}

		function countRejectPage() {
			var pageUrl;
			if ( rejectTotal==0 ) {
				pageUrl="MAX";
			} else if( rejectTotal > rejectCurrentPage*rejectCountPerPage) {
				pageUrl="&page="+rejectCurrentPage+"&size=10";
				rejectCurrentPage++;
			} else if ( rejectTotal <= rejectCurrentPage*rejectCountPerPage ) {
				pageUrl="MAX";
			}
			return pageUrl;
		}

		function getIssuList(searchUrl) {
			var issuPaging=countIssuPage();
			if(issuPaging=="MAX"){
			} else {
				var finalUrl;
				if(searchUrl!=undefined) {
					finalUrl=defaultIssuUrl+searchUrl+issuPaging;
				} else {
					finalUrl=defaultIssuUrl+issuPaging;
				}
				//발급 승인 목록
				$.ajax({
					type: 'GET',
					url: finalUrl,
					async: false,
					contentType: "application/json",
					dataType: 'json',
					success: function (res) {
						res._embedded.elctrnDsnfCerfins.forEach(function(item, index, array){
							makeIssuLi(item);
						})
						//$("#issuUl")[0].innerHTML="데이터가 없습니다.";
					}, 
					complete: function (res) {
					},
					error: function(err) {
						alert("실패");
					}
				});
			}
		}

		function getRejectList(searchUrl) {
			var rejectPaging=countRejectPage();
			if(rejectPaging=="MAX") {

			} else {
				var finalUrl;
				if(searchUrl!=undefined) {
					finalUrl=defaultRejectUrl+searchUrl+rejectPaging;
				} else {
					finalUrl=defaultRejectUrl+rejectPaging;
				}			
				//발급 거절 목록
				$.ajax({
					type: 'GET',
					url: finalUrl,
					async: false,
					contentType: "application/json",
					dataType: 'json',
					success: function (res) {
						res._embedded.elctrnDsnfCerfins.forEach(function(item, index, array){
							makeRejectLi(item);
						//$("#rejectUl")[0].innerHTML="데이터가 없습니다.";
						})
					}, 
					complete: function (res) {
						//window.location.href="./disinfectionList.html"
					},
					error: function(err) {
						alert("실패");
					}
				});
			}
		}

		function makeIssuLi(data) {
			var tempSampleIssuList = sampleIssueList.clone();
			tempSampleIssuList[0].children[0].setAttribute("href","certificate.html?seq="+data.id) /// A태그에 href 추가
			tempSampleIssuList[0].children[0].children[0].children[0].innerHTML=data.carNo;//차량번호
			tempSampleIssuList[0].children[0].children[0].children[1].innerHTML=moment(data.registDt).format('YYYY-MM-DD HH:mm:ss');//등록일시
			tempSampleIssuList[0].children[0].children[0].children[2].children[0].innerText=data.carNo;//등록일시
			tempSampleIssuList[0].children[0].children[0].children[2].children[1].innerText=moment(data.issuDt).format('YYYY-MM-DD HH:mm:ss');//승인일시
			tempSampleIssuList[0].children[0].children[1].children[0].children[0].children[1].innerText=data.strtpnt;
			tempSampleIssuList[0].children[0].children[1].children[0].children[1].children[1].innerText=data.dstn;
			tempSampleIssuList[0].children[0].children[1].children[0].children[2].children[1].innerText=data.visitPurps;
			
			$("#issuUl").append(tempSampleIssuList);
		}

		function makeRejectLi(data) {
			var tempSampleRejectList = sampleRejectList.clone();
			tempSampleRejectList[0].children[0].setAttribute("href","certificate.html?seq="+data.id) /// A태그에 href 추가
			tempSampleRejectList[0].children[0].children[0].children[0].innerHTML=data.carNo;//차량번호
			tempSampleRejectList[0].children[0].children[0].children[1].innerHTML=moment(data.registDt).format('YYYY-MM-DD HH:mm:ss');//등록일시
			tempSampleRejectList[0].children[0].children[0].children[2].children[0].innerText=data.carNo;//등록일시
			if(data.issuRejectDt == null){
				tempSampleRejectList[0].children[0].children[0].children[2].children[1].innerText= "-";
			}else{
				tempSampleRejectList[0].children[0].children[0].children[2].children[1].innerText=moment(data.issuRejectDt).format('YYYY-MM-DD HH:mm:ss');//거절일시
			}
			tempSampleRejectList[0].children[0].children[1].children[0].children[0].children[1].innerText=data.strtpnt;
			tempSampleRejectList[0].children[0].children[1].children[0].children[1].children[1].innerText=data.dstn;
			tempSampleRejectList[0].children[0].children[1].children[0].children[2].children[1].innerText=data.visitPurps;

			$("#rejectUl").append(tempSampleRejectList);
		}

	</script>
</head>

<body>
	<div class="mylist user2 bg-gray" id="wrap">       
		<!-- header -->
		<header class="user2">
			<div class="title-box">
				<!-- <button class="btn-back" onclick="back();">
					<img src="../assets/images/btn-back.png" alt="back">
				</button> -->
				<h1>마이리스트</h1>
			</div>
		</header>
		<!-- //header -->
		<!-- tab menu -->
		<div class="mylist-tab-menu">
			<ul>
				<li class="on"><a href="#box1">발급승인 목록</a></li>
				<li><a href="#box2">발급거절 목록</a></li>
			</ul>
		</div>
		<!-- //tab menu -->
		<!-- mylist search box -->
		<div class="mylist-search-box">
			<button class="btn-calendar" id="btn-condition"><img src="../assets/images/btn-calender.png"
					alt="calendar"></button>
			<div class="input-box search">
				<input type="text" id='searchBox' placeholder="방문목적을 입력하세요.">
				<input type="hidden" id='fromDateValue'>
				<input type="hidden" id='toDateValue'>
				<input type="hidden" id='orderValue'>
				<button class="btn-search"><img src="../assets/images/btn-search-u2.png" alt="serach"></button>
			</div>
		</div>
		<!-- //myllist search box -->
		<div class="container">
			<!-- mypage list -->
			<div id="box1" class="mylist-wrap user2">
				<ul id="issuUl">
					<li class="sampleIssueList">
						<a href="#">
							<div class="top-box">
								<span class="tit">페이지 로딩중...</span>
								<span class="txt">20200202 13:13</span>
								<div class="row">
									<span class="left from"><img src="../assets/images/icon-from.png" alt="출발">
										123가1234</span>
									<span class="right to user2"><img src="../assets/images/icon-to-user1.png" alt="도착">
										20200707 13:33</span>
								</div>
							</div>
							<div class="bottom-box">
								<ul>
									<li>
										<span class="left-tt">출발지</span>
										<span class="right-tt">양양거점소독시설</span>
									</li>
									<li>
										<span class="left-tt">도착지</span>
										<span class="right-tt">양양거점소독시설</span>
									</li>
									<li>
										<span class="left-tt">방문목적</span>
										<span class="right-tt">사료운반</span>
									</li>
								</ul>
							</div>
						</a>
					</li>
				</ul>
			</div>
			<div id="box2" class="mylist-wrap user2">
				<ul id="rejectUl">
					<li class="sampleRejectList">
						<a href="#">
							<div class="top-box">
								<span class="tit">페이지 로딩중...</span>
								<span class="txt">20200202 13:13</span>
								<div class="row">
									<span class="left from"><img src="../assets/images/icon-from.png" alt="출발">
										123가1234</span>
									<span class="right to error"><img src="../assets/images/icon-to-error.png" alt="도착">
										20200707 13:33</span>
								</div>
							</div>
							<div class="bottom-box">
								<ul>
									<li>
										<span class="left-tt">출발지</span>
										<span class="right-tt">양양거점소독시설</span>
									</li>
									<li>
										<span class="left-tt">도착지</span>
										<span class="right-tt">양양거점소독시설</span>
									</li>
									<li>
										<span class="left-tt">방문목적</span>
										<span class="right-tt">사료운반</span>
									</li>
								</ul>
							</div>
						</a>
					</li>
				</ul>
			</div>
		<!-- //mypage list -->
	</div>
	</div>
</body>

</html>