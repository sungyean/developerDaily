<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>거점소독시설</title>
	<link rel="stylesheet" href="../assets/css/common.css">
	<link rel="stylesheet" href="../assets/css/style.css">
	<link rel="stylesheet" href="../../assets/vworld/ol/ol.css" type="text/css">
	<style>
		html, body, #map {
			margin: 0;
			padding: 0;
			width: 100%;
			height: 100%;
		}
		
		.geocoding-wrapper {
			width: 300px;
			position: fixed;
			right: 10px;
			top: 10px;
			background-color: white;
			border: 1px solid #aeaeae;
			padding: 10px;
		}
		
		.geocoding-wrapper h4 {
			margin: 5px;
			padding: 0px;
			width: 100%;
			text-align: center;
		}
		
		.geocoding-wrapper p {
			margin: 5px;
		}
		
		.geocoding-wrapper input{
			width: 100%;
		}
		
		.geocoding-wrapper select{
			width: 100%;
		}
		
		.geocoding-wrapper textarea {
			width: 100%;
		}
		
		.geocoding-wrapper form {
			border: 1px solid #808080;
			padding: 5px;
			
		}

		.map-box #map {width:100%; height:80vh; }
		
	</style>
	 <!-- <script type="text/javascript" src="../assets/js/jquery-3.4.1.min.js"></script>  -->
	<!-- <script type="text/javascript" src="../assets/js/jquery-ui.min.js"></script> -->
	<!-- <script type="text/javascript" src="../assets/js/custom.js"></script> -->
	<script type="text/javascript" src="../../assets/js/comm.js"></script>
	<script src="../../assets/vworld/ol/ol.js"></script>
	<script src="../../assets/vworld/jquery/jquery-1.12.4.min.js"></script>


</head>
<body>
	<div class="map user1" id="wrap">
		<!-- header -->
		<header class="user1">
			<div class="title-box">
				<button class="btn-back" onclick="back();">
					<img src="../assets/images/btn-back.png" alt="back">
				</button>
				<h1>지도보기</h1>
			</div>
		</header>
		<!-- //header -->
		<div class="container">    
			<div class="map-box">
				<div id="map" class="map"></div>	
				<div class="map-info">
					<p class="t1"></p>
					<p class="t2"></p>
				</div>
			</div>        
		</div>
	</div>
	<div class="geocoding-wrapper" style="display:none;">
		<h4>주소검색</h4>
		<hr>
		<p>참조API : <a href="http://www.vworld.kr/dev/v4dv_geocoderguide2_s001.do">VWORLD Geocoder API 2.0</a></p>
		
		<!--주소검색 API 호출할 form -->
		<form id="geocoding" method="GET" action="http://api.vworld.kr/req/address">
		<!-- 위 http://api.vworld.kr/req/address 를 바로 호출 시 Cross Doamin 문제 발생 할 수 있음 -->
		<!-- 아래와 같이 현 시스템에 우회하여 받아오는 로직 구현 필요 -->
		<!-- <form id="geocoding" name="geocoding" action="<c:url value='/com/gis/api/vworld/getAddress.do'/>"> -->
			<label>주소:</label>
			<input type="text" name="address" value="경기도 안양시 동안구 시민대로248번길 25" required/>
			<label>주소정제여부:</label>
			<select name="refine">
				<option value="true">true</option>
				<option value="false">false</option>
			</select>
			<label>검색주소유형:</label>
			<select name="type">
				<option value="ROAD">도로명주소</option>
				<option value="PARCEL">지번주소</option>
			</select>
			<label>응답결과 간략 출력:</label>
			<select name="simple">
				<option value="true">true</option>
				<option value="false">false</option>
			</select>
			<input type="hidden" name="service" value="address"/>
			<input type="hidden" name="version" value="2.0"/>
			<input type="hidden" name="request" value="GetCoord"/>
			
			<!-- VWORLD에서 발급받은 키를 넣어주세요 -->
			<!-- VWORLD에서 발급받은 키를 넣어주세요 -->
			<!-- VWORLD에서 발급받은 키를 넣어주세요 -->
			<input type="hidden" name="key" value="E2FED08B-6880-35D0-BDED-3F5CBF1FC59A"/>
			
			<input type="hidden" name="format" value="json"/>
			<input type="hidden" name="errorFormat" value="json"/>
			<input type="hidden" name="crs" value="EPSG:3857"/>
			<hr>
			<input type="submit" value="검색">
			<input type="button" value="지도 초기화" onclick="clearMapMarker();">
		</form>
		
		<hr>
		<textarea id="response-text" rows="10" readonly></textarea>
		
	</div>

	<script type="text/javascript">

		function back(){
            window.history.back();
        }
		var gridNames = ['EPSG:3857:0', 'EPSG:3857:1', 'EPSG:3857:2', 'EPSG:3857:3', 'EPSG:3857:4', 'EPSG:3857:5', 'EPSG:3857:6', 'EPSG:3857:7', 'EPSG:3857:8', 'EPSG:3857:9', 'EPSG:3857:10', 'EPSG:3857:11', 'EPSG:3857:12', 'EPSG:3857:13', 'EPSG:3857:14', 'EPSG:3857:15', 'EPSG:3857:16', 'EPSG:3857:17', 'EPSG:3857:18', 'EPSG:3857:19', 'EPSG:3857:20', 'EPSG:3857:21', 'EPSG:3857:22', 'EPSG:3857:23', 'EPSG:3857:24', 'EPSG:3857:25', 'EPSG:3857:26', 'EPSG:3857:27', 'EPSG:3857:28', 'EPSG:3857:29'];
		
		var resolutions = [156543.03390625, 78271.516953125, 39135.7584765625, 19567.87923828125, 9783.939619140625, 4891.9698095703125, 2445.9849047851562, 1222.9924523925781, 611.4962261962891, 305.74811309814453, 152.87405654907226, 76.43702827453613, 38.218514137268066, 19.109257068634033, 9.554628534317017, 4.777314267158508, 2.388657133579254, 1.194328566789627, 0.5971642833948135, 0.2985821416974068, 0.1492910708487034, 0.0746455354243517, 0.0373227677121758, 0.0186613838560879, 0.009330691928044, 0.004665345964022, 0.002332672982011, 0.0011663364910055, 5.831682455027E-4, 2.915841227514E-4, 1.457920613757E-4];
		
		var projection = new ol.proj.Projection({
			code: 'EPSG:3857',
			units: 'm',
			axisOrientation: 'neu'
		});
		
		var matrixSet = 'EPSG:3857';
		var format = 'image/png';
		
		var url = 'http://123.213.1.197:8080';
		var wmts_url = url+'/geoserver/gwc/service/wmts';
		
		// 위 wms_url 바로 호출 시 Cross Doamin 문제 발생할 경우 아래와 같이 현 시스템 서버에
		// 위 wms_url 를 api 로 호출하여 결과값을 스트링으로 받아 오는 로직 구현.
		// var url = "<c:out value='/com/gis/api/conGeoSvr.do'/>";	
		// wmts_url = url;
		
		var tileGrid = new ol.tilegrid.WMTS({
			tileSize: [256,256],
			extent: [-2.003750834E7,-2.003750834E7,2.003750834E7,2.003750834E7],
			origin: [-2.003750834E7, 2.003750834E7],
			resolutions: resolutions,
			matrixIds: gridNames
		});
		
		var view = new ol.View({
			center: ol.proj.fromLonLat([128.5,38.0]),
			zoom: 6,
			minZoom: 6,
			maxZoom: 21,
			extent: [12823000,3449129, 15796164,5716304],
		});
		
		
		//주소 검색 결과를 담을 벡터 자료구조 선언
		var geocoding_source = new ol.source.Vector();
		
		//주소 검색 레이어를 생성
		var geocoding_layer = new ol.layer.Vector({
			
			//주소검색 벡터
			source: geocoding_source,
			
			//주소검색 마커 스타일 생성
			style: new ol.style.Style({
				image: new ol.style.Icon({
					//카카오맵 마커이므로 저작권 주의
					//카카오맵 마커이므로 저작권 주의
					//카카오맵 마커이므로 저작권 주의
					src: "../../assets/vworld/images/marker_spot.png",
					anchor: [0.5, 1],
					scale: 0.5
				})
			})
			
		});
		
		var map = new ol.Map({
			target: 'map',
			loadTilesWhileInteracting: true,
			loadTilesWhileAnimating: true,
			controls: ol.control.defaults().extend([
				new ol.control.ScaleLine(),
				new ol.control.ZoomSlider(),
			]),
			layers: [
			
				//정식적인 vworld 위성지도를 불러오는 방법이 아니므로, vworld 사용정책위반임
				//vworld.kr에서 api키 발급 후 아래주석의 레이어 호출방식을 반드시 사용해야함.
				/*
				new ol.layer.Tile({
					preload: Infinity,
					source: new ol.source.XYZ({
						url: 'http://xdworld.vworld.kr:8080/2d/Satellite/service/{z}/{x}/{y}.jpeg',
						transition: 0,
					}),
				}),
				*/
				
				// 정식 vworld 위성지도 호출
							
				new ol.layer.Tile({
					preload: Infinity,
					source: new ol.source.XYZ({
						url: 'http://api.vworld.kr/req/wmts/1.0.0/E2FED08B-6880-35D0-BDED-3F5CBF1FC59A/Satellite/{z}/{y}/{x}.jpeg',
						transition: 0,
					}),
				}),
				
				/*
				new ol.layer.Tile({
					preload: Infinity,
					source: new ol.source.XYZ({
						url: 'http://api.vworld.kr/req/wmts/1.0.0/{API 키 입력}/Satellite/{z}/{y}/{x}.jpeg',
						transition: 0,
					}),
				}),
				*/
				
				//연속지적 레이어
				new ol.layer.Tile({
					extent: [
						13871819.89986,
						3910407.08324951,
						14689136.5123051,
						5084749.87464797
					],
					maxResolution: 2.388657133911758,
					minResolution: 0,
					source: new ol.source.WMTS({
						url: wmts_url,
						layer: 'invako:LSMD_CONT_LDREG',
						matrixSet: matrixSet,
						format: 'image/png',
						projection: projection,
						tileGrid: tileGrid,
						style: '',
						transition: 0,
					}),
				}),
				
				
				
				//법정경계 레이어
				new ol.layer.Tile({
					extent: [
						13871819.899860002,
						3910407.0832495084,
						14689136.512305101,
						4685005.125465867
					],
					maxResolution: 152.8740565703525,
					minResolution: 0,
					source: new ol.source.WMTS({
						url: wmts_url,
						layer: 'invako:ADM_SECT',
						matrixSet: matrixSet,
						format: 'image/png',
						projection: projection,
						tileGrid: tileGrid,
						style: '',
						transition: 0,
					}),
				}),
				
				//주소검색 마커용 레이어 추가
				geocoding_layer,
				
			],
			
			view: view,
		});







		$('#geocoding').submit(function(e){
		
			e.preventDefault();
			
			// 지도에서 주소검색 마커를 삭제
			clearMapMarker();
			
			var form = $(this);
			var url = form.attr('action');
			var data = form.serialize(); 
			
			
			$.ajax({
				type: 'GET',
				//dataType:"json",
				dataType:"jsonp",	//cors로 jsonp 사용
				url: url,
				data: data,
			})
			.done(function(resp){
			
				var status = resp.response.status;
				
				if(status === "OK"){	//검색결과가 존재하는경우
				
					//json 결과로부터 좌표 추출
					//json 구조는 api 페이지 참조
					var result = resp.response.result;
					var point = result.point;
				
					//문자열형태인 좌표를 float형으로 변환
					var points = [
						parseFloat(point['x']), 
						parseFloat(point['y'])
					];
					
					addMarkerWithMove(points);
					
				}else if(status === "NOT_FOUND"){	//검색결과가 없는경우
					alert("결과가 없습니다.");
				}else{	//이외의 에러
					alert("에러가 발생하였습니다.");
				}
				
				//결과 JSON을 textarea에 표시
				$('#response-text').val(JSON.stringify(resp));
				
			})
			.fail(function(resp){
				$('#response-text').val(JSON.stringify(resp));
				alert("주소API호출에 실패하였습니다.");
			});
			
			//검색중 안내메세지를 textarea에 출력
			$('#response-text').val('주소 검색중입니다......');
		});
	
	
	
	//지도상의 마커 제거
	function clearMapMarker(){
	
		// 벡터소스를 clear시 자동으로 화면에서 마커가 삭제됨
		geocoding_source.clear();
		
	}
	
	function addMarkerWithMove(points){
		//점 좌표 생성
		var point_geom = new ol.geom.Point(points);
		
		//마커용 Feature 생성
		var feature = new ol.Feature(point_geom);
		
		//
		//벡터소스에 데이터를 추가하면 자동으로 화면에 마커가 나타남
		geocoding_source.addFeature(feature);
	
		//지도 이동 및 줌레벨 18로 이동
		view.setZoom(18);
		view.setCenter(points);
	}
	
	var seq=window.location.href.split("?")[1].substring(3);
	$.ajax({
		type: 'GET',
		url: global.apiUrl+"/cmDsnfFclties/"+seq,
		async: false,
		contentType: "application/json",
		dataType: 'json',
		success: function (res) {
			console.log(res)
			/* if(res.userSelectedType=='R') { */
			$('select[name=type]').val('ROAD').prop("selected", true);
/* 			} else {
				$('select[name=type]').val('PARCEL').prop("selected", true);
			} */
			$('input[name=address]').val(res.rnAdres1+res.adres2);
			$(".t1")[0].innerHTML=res.nm;
			$(".t2")[0].innerHTML=res.rnAdres1+res.adres2;
		}, 
		complete: function (res) {
			//window.location.href="./disinfectionList.html"
		},
		error: function(err) {
			alert("실패");
		}
	});

	$('#geocoding').submit();
	</script>
</body>
</html>