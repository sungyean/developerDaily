<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>거점소독시설</title>
    <link rel="stylesheet" href="../assets/css/common.css">
	<link rel="stylesheet" href="../assets/css/style.css">
	<script type="text/javascript" src="../assets/js/jquery-3.4.1.min.js"></script>
	<script type="text/javascript" src="../assets/js/jquery-ui.min.js"></script>
	<script type="text/javascript" src="../assets/js/custom.js"></script>
	<!-- 공통 js -->
	<script type="text/javascript" src="../../assets/js/comm.js"></script>
	<!-- validatate 체크 -->
	<script type="text/javascript" src="../assets/js/jquery.validate.min.js"></script>
    <script type="text/javascript" src="../../assets/js/sessionChk.js"></script>
    <!-- 공통 모달 -->
    <script type="text/javascript" src="../../assets/js/confirmModal.js"></script>
    <script type="text/javascript">
    let getlocalStorage = localStorage.getItem('SignInAccount');
    getlocalStorage = JSON.parse(getlocalStorage);
    $(document).ready(function(){
        /* localStroage 에서 accountId 제거 */
        //키 값을 아예 제거하면 다른페이지에서 accountId를 불러올때 오류
        $("#deviceTy").val(getlocalStorage.deviceTy);
        $("#mobileDeviceId").val(getlocalStorage.mobileDeviceId);
        $("#firebaseToken").val(getlocalStorage.firebaseToken);
        
    })
    $(function(){ 
        $("#loginSubmit").validate({
            //validation이 끝난 이후의 submit 직전 추가 작업할 부분
            submitHandler: function(form, event) { 
                event.preventDefault(); //form 의 submit 을 막고 ajax 로 동작하기 위한 구문
                var tempArray = $(form).serializeArray();
                var formData = {}
                for (i = 0; i < tempArray.length; i++) {
                    formData[tempArray[i].name] = tempArray[i].value;
                }
                console.log("formData",JSON.stringify(formData));
                $.ajax({
                    type: 'POST',
                    url: global.apiUrl+"/appLogin",
                    async: false,
                    data: JSON.stringify(formData),
                    contentType: "application/json",
                    dataType: 'json',
                    success: function (res) {
                        if(res.status == "DELETE"){
                            modalAlert("탈퇴한 회원입니다.")
                            return false;
                        }
                        if(res.returnCode == "ID_SEARCH_FAILR"){
                            modalAlert("입력한 정보가 올바르지 않습니다.");
                            return false;
                        }
                        /* 단말기 갱신(기기변경) START*/
                        if(res.returnCode == "TRMNL_UPDT_NEED"){
                            $('#deviceUpdateText').html(res.returnMsg);
                            $('#deviceUpdate').fadeIn();
                        /* 단말기 갱신(기기변경) END */
                        }
                        /* 비밀번호 5회 오류시 */
                        if(res.returnCode == "PASSWORD_DSCRD"){
                            if(res.passwordDscrdCo >5){
                                modalAlert("비밀번호를 5회 잘못 입력하셨습니다. 비밀번호 재설정후 이용해주세요.");
                                window.location.href="./findIdPw.html";
                            }
                        }
                        if(res.returnCode == "PASSWORD_DSCRD"){
                            modalAlert("입력한 정보가 올바르지 않습니다.");
                            return false;
                        }
                        /* 로그인 성공시 */
                        if(res.returnCode == "SUCCES"){
                            loginSuccess(res);
                        }
                    },
                    error: function(err) {
                        console.log("err",err);
                        modalAlert("로그인에 실패했습니다.");
                        return false;
                    }
                });
            },
            //규칙
            rules: {
                accountId: {
                    required : true,
                    minlength : 4,
                    maxlength : 20
                },
                passwd: {
                    required : true,
                    minlength : 8,
                    maxlength : 20
                }
            },
            //규칙체크 실패시 출력될 메시지
            messages : {
                accountId: {
                    required : "필수로 입력하세요.",
                    minlength : "최소 {0}글자이상 이어야 합니다",
                    maxlength : "최대 {0}글자이하 이어야 합니다"
                },
                passwd: {
                    required : "필수로 입력하세요",
                    minlength : "최소 {0}글자이상 이어야 합니다",
                    maxlength : "최대 {0}글자이하 이어야 합니다"
                }
            }
        });
    });
    /* device 장치 업데이트시 location 화면 이동 */
    function loginSuccess(res){
        localStorage.setItem("SignInAccount", JSON.stringify(res));
        //console.log("res", res);
        let postMessageList = {
            res,
            address : location.search
        }
        
        try {
            if(getlocalStorage.deviceTy == "ANDROID"){
                Hybrid.setAndroidLoginFlag(JSON.stringify(res),location.search);
            }else{//getlocalStorage.deviceTy == "IOS"
                webkit.messageHandlers.setIosLoginFlag.postMessage(JSON.stringify(postMessageList));
            }
        } catch (exception) {
            console.log("exception",exception)
        } 
                
        //축산차량 운전자 일 경우 
        if(res.accountTy =="STKRS_VHCLE_DRVER"){
            //앱에서 동작기능.
            if(location.search != ""){
                window.location.href="../drver/step1.html"+location.search    
            }else{
                window.location.href="../drver/home.html"
            }
        //거점소독시설관리자
        }else if(res.accountTy =="POSITN_DSNF_FCLTY_MNGR"){
            window.location.href="../disinfectionFclty/home.html"
        //축산시설(농장)담당자
        }else if(res.accountTy =="STKRS_FCLTY_CHARGER"){
            window.location.href="../stkrsFclty/homeVisit.html"
        }        
    }
    /* 기기 변경시 update */
    function deviceUpdate(){
        var tempArray = $("#loginSubmit").serializeArray();
        var formData = {}
        for (i = 0; i < tempArray.length; i++) {
            formData[tempArray[i].name] = tempArray[i].value;
        }
        /* 업데이트 */
        formData.forceUpdateMobileDeviceId = true;
        $.ajax({
            type: 'POST',
            url: global.apiUrl+"/appLogin",
            async: false,
            data: JSON.stringify(formData),
            contentType: "application/json",
            dataType: 'json',
            success: function (res) {
                loginSuccess(res)
            }
        })
    }
    function modal_close() {
        event.preventDefault();
        $('#deviceUpdate').hide();
    }
    </script>
</head>
<body>
    <div class="login bg-gray" id="wrap">
        <div class="container pd-yes">
            <h1 class="title login">로그인</h1>
            <form id="loginSubmit">
                <div class="input-box lg">
                    <input type="text" id="accountId" name="accountId" placeholder="아이디">
                </div>
                <div class="input-box lg">
                    <input type="password" id="passwd" name="passwd" placeholder="비밀번호">
                </div>
                <input type="hidden" id="deviceTy" name="deviceTy">
                <input type="hidden" id="mobileDeviceId" name="mobileDeviceId">
                <input type="hidden" id="firebaseToken" name="firebaseToken">
                <!-- <div class="btn-wrap one">
                    <button type="submit" class="btn bg-green lg btn-login">로그인</button>
                </div> -->
                <div class="btn-wrap double">
                    <button type="submit" style="width: 48%;" class="btn bg-green lg btn-login">로그인</button>
                    <button type="button" onclick="location.href ='./join.html';" style="width: 48%;" class="btn bg-green lg btn-login">회원가입</button>
                </div>
                <div class="btn-wrap one">
                    <button type="button" onclick="location.href ='./findIdPw.html';" class="btn bg-green lg btn-login">아이디/비밀번호 찾기</button>
                </div>
            </form>
            <div class="btn-wrap one">
            </div>
            <!-- deviceUpdate modal-->
            <div class="popup-wrap delete sm" id="deviceUpdate">
                <div class="popup-box sm">
                    <div class="popup-header sm">
                        <!-- <p>확인</p> -->
                        <a href="#" class="btn-popup-close"><img src="../assets/images/btn-popup-close.png"alt="팝업닫기"></a>
                    </div>
                    <div class="popup-contents sm">
                        <p class="txt" id="deviceUpdateText"></p>
                    </div>
                    <div class="popup-footer sm">
                        <button type="button" class="btn bg-gray btn-cancel" onclick="modal_close();">취소</button>
                        <button type="submit" class="btn bg-green btn-delete" onclick="deviceUpdate();">확인</button>
                    </div>
                </div>
            </div> 
            <!-- deviceUpdate modal-->
        </div>
    </div>
</body>
</html>