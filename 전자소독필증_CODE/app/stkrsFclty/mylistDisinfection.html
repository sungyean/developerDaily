<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>시설관리자 소독내역</title>
	<link rel="stylesheet" href="../assets/css/common.css">
	<link rel="stylesheet" href="../assets/css/style.css">
	<script type="text/javascript" src="../assets/js/jquery-3.4.1.min.js"></script>
	<script type="text/javascript" src="../assets/js/jquery-ui.min.js"></script>
	<script type="text/javascript" src="../assets/js/custom.js"></script>
	<script type="text/javascript" src="../../assets/js/comm.js"></script>
	<script type="text/javascript" src="../../assets/js/sessionChk.js"></script>
	<script type="text/javascript" src="../../assets/js/conditionModal.js"></script>
	<script type="text/javascript">
		//session Check localStorage에 accountId 없을 경우 login Page로 이동
		sessionChk();
		var loginUserId =  getSigninAccount().accountId;
		//var loginUserSeq = getSigninAccount().seq;
		var loginUserSeq = 1;
		var loginUserWorkCmStkrsFcltyInfoMId = "";
		var loginUserFacilityType="";
		var loginUserFacilityid="";
		if(getSigninAccount().cmFarmInfoM!=undefined) {
			loginUserFacilityType="farm";
			loginUserFacilityid=getSigninAccount().cmFarmInfoM.farmNo;
		} else {
			loginUserFacilityType="stkrsFclty";
			loginUserFacilityid=getSigninAccount().cmStkrsFcltyInfoM.id;
		}
		loginUserWorkCmStkrsFcltyInfoMId=getSigninAccount().orgId;

		$(document).ready(function() {
			var tempSampleDisinfectionList = $('#sampleDisinfectionLi');
			var sampleDisinfectionList = tempSampleDisinfectionList.clone();
			tempSampleDisinfectionList.css("display", "none");
			

			var getMyList = function(searcEstnhUrl) {
				$("#allUl").empty();
				$("#issuUl").empty();
				$("#rejectUl").empty();

				var searchUrl="";
				if(searcEstnhUrl != null) {
					searchUrl=searcEstnhUrl;
				}

				$.ajax({
					type: 'GET',
					//url: global.apiUrl+"/elctrnDsnfCerfins/search/findByIssuFclty_IdAndStatusOrderByIdDesc?issuFcltyId="+loginUserWorkCmStkrsFcltyInfoMId+"&status=REQST",
					url: global.apiUrl+"/elctrnDsnfCerfin/estnSearch?&sort=id,desc&page=0&size=10"+getEstnUrl("issuFarmNo",getSigninAccount().orgId,"STRING","EQ")+searchUrl,
					async: false,
					contentType: "application/json",
					dataType: 'json',
					success: function (res) {
						if(res._embedded.elctrnDsnfCerfin.length!=0){
							res._embedded.elctrnDsnfCerfin.forEach(function(item, index, array){
								makeIssueLi(item)
							})
						}
					},
					complete: function (res) {
						
					},
					error: function(err) {
						alert("실패");
					}
				});

				$.ajax({
					type: 'GET',
					url: global.apiUrl+"/elctrnDsnfCerfin/estnSearch?&sort=id,desc&page=0&size=10"+getEstnUrl("issuFarmNo",getSigninAccount().orgId,"STRING","EQ")+getEstnUrl("status","USE","com.kware.dis.jpa.dis.domain.ElctrnDsnfCerfin$Status","EQ")+searchUrl,
					async: false,
					contentType: "application/json",
					dataType: 'json',
					success: function (res) {
						if(res._embedded.elctrnDsnfCerfin.length!=0){
							res._embedded.elctrnDsnfCerfin.forEach(function(item, index, array){
								makeConfirmLi(item)
							})
						}
					},
					complete: function (res) {
						
					},
					error: function(err) {
						alert("실패");
					}
				});


				$.ajax({
					type: 'GET',
					url: global.apiUrl+"/elctrnDsnfCerfin/estnSearch?&sort=id,desc&page=0&size=10"+getEstnUrl("issuFarmNo",getSigninAccount().orgId,"STRING","EQ")+getEstnUrl("status","ISSU_REJECT","com.kware.dis.jpa.dis.domain.ElctrnDsnfCerfin$Status","EQ")+searchUrl,
					async: false,
					contentType: "application/json",
					dataType: 'json',
					success: function (res) {
						if(res._embedded.elctrnDsnfCerfin.length!=0){
							res._embedded.elctrnDsnfCerfin.forEach(function(item, index, array){
								makeRejectLi(item)
							})
						}
					},
					complete: function (res) {
						
					},
					error: function(err) {
						alert("실패");
					}
				});
			}
			getMyList();
			function makeIssueLi(data) {
				var tempSampleDisinfectionList = sampleDisinfectionList.clone();
				//console.log(tempSampleDisinfectionList[0].children[0])
				tempSampleDisinfectionList[0].children[0].children[0].children[0].innerHTML=data.carNo;//차량번호
				//전자소독필증 발급/미발급 시 이미지 파일 변경
				if(data.status == "ISSU" || data.status == "USE_REJECT") {
					tempSampleDisinfectionList[0].children[0].children[0].children[1].innerHTML="<img src='../assets/images/icon-clean-ok.png' alt='clean'>";
				} else {
					tempSampleDisinfectionList[0].children[0].children[0].children[1].innerHTML="<img src='../assets/images/icon-clean-error.png' alt='clean'>";
				}
				tempSampleDisinfectionList[0].children[0].children[0].children[2].children[0].innerHTML="<img src='../assets/images/icon-from.png' alt='출발'>"+data.carNo;

				if(data.status == "ISSU") {
					tempSampleDisinfectionList[0].children[0].children[0].children[2].children[1].innerHTML="<img src='../assets/images/icon-to-user3.png' alt='도착'>"+data.registDt;
				} else if (data.status == "REJECT") {
					tempSampleDisinfectionList[0].children[0].children[0].children[2].children[1].innerHTML="<span class='right to error'><img src='../assets/images/icon-to-error.png' alt='도착'> 20200707 13:33</span>"+data.registDt;
				}

				tempSampleDisinfectionList[0].children[0].children[1].children[0].children[0].children[1].innerText=data.strtpnt;//출발지
				tempSampleDisinfectionList[0].children[0].children[1].children[0].children[0].children[1].innerText=data.dstn;//도착지
				tempSampleDisinfectionList[0].children[0].children[1].children[0].children[0].children[1].innerText=data.visitPurps;//방문목적
				if(data.status=="REQST") {
					tempSampleDisinfectionList.children('a').append("<div class='btn-wrap double'><button class='btn bg-gray md btn-map' onclick='certificateDeny("+data.id+")'>발급거절</button><button class='btn bg-darkblue md btn-apply' onclick='certificate("+data.id+")'>발급승인</button></div>");
				} else {
					
				}

				tempSampleDisinfectionList.addClass('nn')
				
				$("#allUl").append(tempSampleDisinfectionList);

			}


			function makeConfirmLi(data) {
				var tempSampleDisinfectionList = sampleDisinfectionList.clone();
				//console.log(tempSampleDisinfectionList[0].children[0])
				tempSampleDisinfectionList[0].children[0].children[0].children[0].innerHTML=data.carNo;//차량번호
				//전자소독필증 발급/미발급 시 이미지 파일 변경
				if(data.status == "ISSU" || data.status == "USE_REJECT") {
					tempSampleDisinfectionList[0].children[0].children[0].children[1].innerHTML="<img src='../assets/images/icon-clean-ok.png' alt='clean'>";
				} else {
					tempSampleDisinfectionList[0].children[0].children[0].children[1].innerHTML="<img src='../assets/images/icon-clean-error.png' alt='clean'>";
				}
				tempSampleDisinfectionList[0].children[0].children[0].children[2].children[0].innerHTML="<img src='../assets/images/icon-from.png' alt='출발'>"+data.carNo;

				if(data.status == "ISSU") {
					tempSampleDisinfectionList[0].children[0].children[0].children[2].children[1].innerHTML="<img src='../assets/images/icon-to-user3.png' alt='도착'>"+data.registDt;
				} else if (data.status == "REJECT") {
					tempSampleDisinfectionList[0].children[0].children[0].children[2].children[1].innerHTML="<span class='right to error'><img src='../assets/images/icon-to-error.png' alt='도착'> 20200707 13:33</span>"+data.registDt;
				}

				tempSampleDisinfectionList[0].children[0].children[1].children[0].children[0].children[1].innerText=data.strtpnt;//출발지
				tempSampleDisinfectionList[0].children[0].children[1].children[0].children[0].children[1].innerText=data.dstn;//도착지
				tempSampleDisinfectionList[0].children[0].children[1].children[0].children[0].children[1].innerText=data.visitPurps;//방문목적
				if(data.status=="REQST") {
					tempSampleDisinfectionList.children('a').append("<div class='btn-wrap double'><button class='btn bg-gray md btn-map' onclick='certificateDeny("+data.id+")'>발급거절</button><button class='btn bg-darkblue md btn-apply' onclick='certificate("+data.id+")'>발급승인</button></div>");
				} else {
					
				}

				tempSampleDisinfectionList.addClass('tt')
				
				$("#issuUl").append(tempSampleDisinfectionList.clone());
			}



			function makeRejectLi(data) {
				var tempSampleDisinfectionList = sampleDisinfectionList.clone();
				//console.log(tempSampleDisinfectionList[0].children[0])
				tempSampleDisinfectionList[0].children[0].children[0].children[0].innerHTML=data.carNo;//차량번호
				//전자소독필증 발급/미발급 시 이미지 파일 변경
				if(data.status == "ISSU" || data.status == "USE_REJECT") {
					tempSampleDisinfectionList[0].children[0].children[0].children[1].innerHTML="<img src='../assets/images/icon-clean-ok.png' alt='clean'>";
				} else {
					tempSampleDisinfectionList[0].children[0].children[0].children[1].innerHTML="<img src='../assets/images/icon-clean-error.png' alt='clean'>";
				}
				tempSampleDisinfectionList[0].children[0].children[0].children[2].children[0].innerHTML="<img src='../assets/images/icon-from.png' alt='출발'>"+data.carNo;

				if(data.status == "ISSU") {
					tempSampleDisinfectionList[0].children[0].children[0].children[2].children[1].innerHTML="<img src='../assets/images/icon-to-user3.png' alt='도착'>"+data.registDt;
				} else if (data.status == "REJECT") {
					tempSampleDisinfectionList[0].children[0].children[0].children[2].children[1].innerHTML="<span class='right to error'><img src='../assets/images/icon-to-error.png' alt='도착'> 20200707 13:33</span>"+data.registDt;
				}

				tempSampleDisinfectionList[0].children[0].children[1].children[0].children[0].children[1].innerText=data.strtpnt;//출발지
				tempSampleDisinfectionList[0].children[0].children[1].children[0].children[0].children[1].innerText=data.dstn;//도착지
				tempSampleDisinfectionList[0].children[0].children[1].children[0].children[0].children[1].innerText=data.visitPurps;//방문목적
				if(data.status=="REQST") {
					tempSampleDisinfectionList.children('a').append("<div class='btn-wrap double'><button class='btn bg-gray md btn-map' onclick='certificateDeny("+data.id+")'>발급거절</button><button class='btn bg-darkblue md btn-apply' onclick='certificate("+data.id+")'>발급승인</button></div>");
				} else {
					
				}

				tempSampleDisinfectionList.addClass('ff')
				
				$("#rejectUl").append(tempSampleDisinfectionList.clone());
			}

			

			const searchValue=document.getElementById('searchBox');
			//const searchValue=document.querySelector('input[type="search"]');
			const fromDateValue=$('#fromDateValue');
			const toDateValue=$('#toDateValue');
			const orderValue=$('#orderValue');

			$('#btn-condition').click(function() {
				makeConditionModal(searchValue, fromDateValue, toDateValue, orderValue, getMyList);
			})

		})

		//발급 승인시 이벤트 함수
		function certificate(id) {

			$.ajax({
				type: 'PUT',
				url: global.apiUrl+"/elctrnDsnfCerfins/"+id+"/issue",
				async: false,
				contentType: "application/json",
				data : JSON.stringify({"issuer" : {"seq" : loginUserSeq}}),
				dataType: 'json',
				success: function (res) {
					alert("전자소독필증이 발급되었습니다.")
				}, 
				complete: function (res) {
					location.reload(true);
				},
				error: function(err) {
					alert("실패");
				}
			});

		}

		//발급 거절시 이벤트 함수
		function certificateDeny(id){

			$.ajax({
				type: 'PUT',
				url: global.apiUrl+"/elctrnDsnfCerfins/"+id+"/update",
				async: false,
				contentType: "application/json",
				dataType: 'json',
				data : JSON.stringify({"status" : "ISSU_REJECT"}),
				success: function (res) {
					alert("거절되었습니다.")
				}, 
				complete: function (res) {
					location.reload(true);
				},
				error: function(err) {
					alert("실패");
				}
			});

		}

		
	</script>
	<style>
		.user3 .ff:after {content:''; position: absolute; top:1rem; left:0; width:8px; height:32px; background-color: #ff0000;} 
		.user3 .tt:after {content:''; position: absolute; top:1rem; left:0; width:8px; height:32px; background-color: #244276;} 
		.user3 .nn:after {content:''; position: absolute; top:1rem; left:0; width:8px; height:32px; background-color: #00FF00;} 
	</style>
</head>
<body>
	<div class="mylist user4 bg-gray" id="wrap">
		<!-- header -->
		<header class="user4">
			<button class="btn-back">
				<img src="../assets/images/btn-back.png" alt="back">
			</button>
			<div class="title-box">
				<h1>마이리스트</h1>
			</div>
		</header>
		<!-- //header -->
		<!-- tab menu -->
		<div class="mylist-tab-menu">
			<ul>
				<li class="on"><a href="#box1">전체</a></li>
				<li><a href="#box2">발급승인 목록</a></li>
				<li><a href="#box3">발급거절 목록</a></li>
			</ul>
		</div>
		<!-- //tab menu -->
		<!-- mylist search box -->
		<div class="mylist-search-box">
			<a class="btn-calendar" id="btn-condition"><img src="../assets/images/btn-calender.png" alt="calendar"></a>
			<div class="input-box search">
				<input type="text" id="searchBox" placeholder="방문목적을 입력하세요.">
				<input type="hidden" id='fromDateValue'>
				<input type="hidden" id='toDateValue'>
				<input type="hidden" id='orderValue'>
				<button class="btn-search"><img src="../assets/images/btn-search-u2.png" alt="serach"></button>
			</div>
		</div>
		<!-- //myllist search box -->
		<div class="container">            
		<!-- mypage list -->
		<div id="box1" class="mylist-wrap user4">
				<ul id="allUl"> 
				</ul>
		</div>
		<div id="box2" class="mylist-wrap user4">
				<ul id="issuUl">
					<li id="sampleDisinfectionLi">
						<a href="#">
							<div class="top-box">
								<p class="tit">123가1234</p>
								<button class="btn-clean">
									<img src="../assets/images/icon-clean-error.png" alt="clean">
								</button>
								<div class="row">
									<span class="left from"><img src="../assets/images/icon-from.png" alt="출발"> 123가1234</span>
									<span class="right to user4"><img src="../assets/images/icon-to-user3.png" alt="도착"> 20200707 13:33</span>
								</div>
							</div>
							<div class="bottom-box">
								<ul>
									<li>
										<span class="left-tt">출발지</span>
										<span class="right-tt">양양거점소독시설</span>
									</li>
									<li>
										<span class="left-tt">도착지</span>
										<span class="right-tt">양양거점소독시설</span>
									</li>
									<li>
										<span class="left-tt">방문목적</span>
										<span class="right-tt">사료운반</span>
									</li>
								</ul>
							</div>
						</a>
					</li>
				</ul>
			</div>
			<div id="box3" class="mylist-wrap user4">
				<ul id="rejectUl">
				</ul>
			</div>
		<!-- //mypage list -->
		</div>
		<!-- floating btn -->
		<div class="btn-floating">
			<a class="bg-blue" href="./mylistVisit.html">방문목록 보러가기<img src="../assets/images/btn-floating-back.png" alt="바로가기"></a>
		</div>
		<!-- floating btn -->        
	</div>
</body>
</html>
