<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시설</title>
    <link rel="stylesheet" href="../assets/css/common.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <script type="text/javascript" src="../assets/js/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="../assets/js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../assets/js/custom.js"></script>
	<script type="text/javascript" src="../../assets/js/comm.js"></script>
	<script type="text/javascript" src="../../assets/js/confirmModal.js"></script>
	<script type="text/javascript" src="../../assets/js/sessionChk.js"></script>
	<script type="text/javascript" src="../../assets/js/searchModal.js"></script>
	<script type="text/javascript" src="../../assets/js/addVisitHistoryModal.js"></script>
	<script type="text/javascript">
		//session Check localStorage에 accountId 없을 경우 login Page로 이동
		sessionChk();
		var loginUserId =  getSigninAccount().accountId;

		var loginUserFacilityid="";
		var defaultUrl="";
		if(getSigninAccount().cmFarmInfoM!=undefined) {
			loginUserFacilityid=getSigninAccount().cmFarmInfoM.farmNo;
			//defaultUrl = "/visitHistories/search/findByCmStkrsFcltyInfoM_Id?id="+loginUserFacilityid;
			defaultUrl = global.apiUrl+"/visitHistories/estnSearch?"+getEstnUrl("disinfectionFacilityId", loginUserFacilityid ,"NUMBER", "EQ")+"&sort=id,desc";
		} else {
			loginUserFacilityid=getSigninAccount().orgId;
			//defaultUrl = "/visitHistories/search/findByCmFarmInfoM_FarmNo?farmNo="+loginUserFacilityid;
			defaultUrl = global.apiUrl+"/visitHistories/estnSearch?"+getEstnUrl("farmNo", loginUserFacilityid ,"STRING", "EQ")+"&sort=id,desc";
		}

		var tempSampleVisitList;
		var sampleVisitList;

		//페이징 처리
		var CurrentPage = 0;			//현재 페이지
		var CountPerPage = 10;			//페이지 당 갯수
		var Total = 0;					//총 갯수

		var filter="";

		$(document).ready(function() {
			tempSampleVisitList = $('.sampleVisitList');
			sampleVisitList = tempSampleVisitList.clone();
			tempSampleVisitList.css("display", "none");

			getTotalPage(defaultUrl);

			getVisitHistory(defaultUrl);
			const searchBox =document.getElementById('searchKeyword');
			//const searchBox =document.querySelector('input[type="search"]');
			$('#searchKeyword').focus(function() {
				makeSearchModal(searchBox, findVisitBySearch)
			})

		});

		function getVisitHistory(url) {
			var page=countPage();
			if(page=='MAX') {
			} else {
				$.ajax({
					type: 'GET',
					url: url+page,
					async: false,
					contentType: "application/json",
					dataType: 'json',
					success: function (res) {
						res._embedded.visitHistories.forEach(function(item, index, array){
							var tempSampleVisitList = sampleVisitList.clone();
							tempSampleVisitList[0].children[0].children[0].innerHTML=item.carNo;//차량번호
							//전자소독필증 발급/미발급 시 이미지 파일 변경
							if(item.edcStatus == "ISSU" || item.edcStatus == "USE_REJECT") {
								tempSampleVisitList[0].children[0].children[1].innerHTML="<img src='../assets/images/icon-clean-ok.png' alt='clean'>";
							} else {
								tempSampleVisitList[0].children[0].children[1].innerHTML="<img src='../assets/images/icon-clean-error.png' alt='clean'>";
							}
							tempSampleVisitList[0].children[1].children[0].children[0].children[1].innerText=item.strtpnt;//출발지
							tempSampleVisitList[0].children[1].children[0].children[1].children[1].innerText=item.dstn;//도착지
							tempSampleVisitList[0].children[1].children[0].children[2].children[1].innerText=item.visitPurps;//방문목적
							if (item.visitConfmAt==true || item.visitConfmAt==false) {
								tempSampleVisitList[0].children[2].innerHTML="";
							} else {
								tempSampleVisitList[0].children[2].children[0].setAttribute('onclick', "makeConfirmModal('방문을 취소하시겠습니까?', 'visitCancel("+item.id+")'); ")
								tempSampleVisitList[0].children[2].children[1].setAttribute('onclick', "makeConfirmModal('방문을 확인하시겠습니까?', 'visitConfirm("+item.id+")'); ")
							}
							if(item.visitConfmAt==null){
								tempSampleVisitList.addClass('nn')
							} else if (item.visitConfmAt==true) {
								tempSampleVisitList.addClass('tt')
							} else if (item.visitConfmAt==false) {
								tempSampleVisitList.addClass('ff')
							}
							$("#visitUl").append(tempSampleVisitList);
						})
					}, 
					complete: function (res) {
						//window.location.href="./disinfectionList.html"
					},
					error: function(err) {
						//alert("실패");
					}
				});
			}
		}

		function findVisitBySearch (name) {
			$('#visitUl').empty();
			//페이징 초기화
			CurrentPage = 0;			//현재 페이지
			Total = 0;					//총 갯수
			filter = getEstnUrl("visitPurps", $('#searchKeyword').val(), "String","LK");

			getTotalPage(defaultUrl+filter);
			getVisitHistory(defaultUrl+filter);

			//최근검색어 로컬스토리지 저장
			if($('#searchKeyword').val()!=null&&$('#searchKeyword').val()!=""){
				if(localStorage.getItem("stkrsFcltyHomeVisitRecentSearchKeyword")==null) {
					var temp = [{item1: "", item2: "", item3: "", item4: "", item5: ""}];
					localStorage.setItem("stkrsFcltyHomeVisitRecentSearchKeyword", JSON.stringify(temp))
				}
				var strksFcltyHomeVisitRecentSearchKeyword = JSON.parse(localStorage.getItem("stkrsFcltyHomeVisitRecentSearchKeyword"));
				strksFcltyHomeVisitRecentSearchKeyword[0].item5=strksFcltyHomeVisitRecentSearchKeyword[0].item4;
				strksFcltyHomeVisitRecentSearchKeyword[0].item4=strksFcltyHomeVisitRecentSearchKeyword[0].item3;
				strksFcltyHomeVisitRecentSearchKeyword[0].item3=strksFcltyHomeVisitRecentSearchKeyword[0].item2;
				strksFcltyHomeVisitRecentSearchKeyword[0].item2=strksFcltyHomeVisitRecentSearchKeyword[0].item1;
				strksFcltyHomeVisitRecentSearchKeyword[0].item1=$('#searchKeyword').val()

				localStorage.setItem("stkrsFcltyHomeVisitRecentSearchKeyword", JSON.stringify(strksFcltyHomeVisitRecentSearchKeyword));
			}
		}

		//방문확인 시 이벤트 함수
		function visitConfirm(id){
			var data = {
				"visitConfmAt": true,
				"edc" : {
					"cnfrmr" : {
						"beaconUserId": loginUserId
					}
					,"useFarm" : {
						"farmNo": loginUserFacilityid
					}			
				}	
			}				

			$.ajax({
				type: 'PUT',
				url: global.apiUrl+"/visitHistories/"+id+"/updateVisitConfmAt",
				async: false,
				contentType: "application/json",
				data : JSON.stringify(data),
				dataType: "json",
				success: function (res) {
					console.log(res);
					alert("방문을 확인하였습니다.");
					location.reload(true);
				}, 
				complete: function (res) {
					//window.location.href="./disinfectionList.html"
				},
				error: function(err) {
					alert("실패");
				}
			});

		}
		
		//방문 거절시 이벤트 함수
		function visitCancel(id){
			var data = {
				"visitConfmAt": false,
				"edc" : {
					"issueRejectorPbud" : {
						"beaconUserId": loginUserId
					}
					,"useFarm" : {
						"farmNo": loginUserFacilityid
					}			
				}	
			}	
			$.ajax({
				type: 'PUT',
				url: global.apiUrl+"/visitHistories/"+id+"/updateVisitConfmAt",
				async: false,
				contentType: "application/json",
				data : JSON.stringify(data),
				dataType: 'json',
				success: function (res) {
					alert("방문을 취소하였습니다.");
					location.reload(true);
				}, 
				complete: function (res) {
					//window.location.href="./disinfectionList.html"
				},
				error: function(err) {
					alert("실패");
				}
			});

		}
		
		function getTotalPage(url) {
			$.ajax({
				type: 'GET',
				url: url,
				async: false,
				contentType: "application/json",
				dataType: 'json',
				success: function (res) {
					Total=res.page.totalElements;
				}, 
				complete: function (res) {
					//window.location.href="./disinfectionList.html"
				},
				error: function(err) {
					//alert("실패");
				}
			});
		}

		function countPage() {
			var pageUrl;
			if ( Total==0 ) {
				pageUrl="MAX";
			} else if( Total > CurrentPage*CountPerPage) {
				pageUrl="&page="+CurrentPage+"&size=10";
				CurrentPage++;
			} else if ( Total <= CurrentPage*CountPerPage ) {
				pageUrl="MAX";
			}
			return pageUrl;
		}

		$(window).scroll(function () {
			if($(window).scrollTop()-1 < $(document).height() - $(window).height() && $(window).scrollTop()+1 > $(document).height() - $(window).height()) {
				getVisitHistory(defaultUrl+filter);
			}
		});

	</script>
	<style>
		.user3 .list-card .ff:after {content:''; position: absolute; top:1rem; left:0; width:8px; height:32px; background-color: #ff0000;} 
		.user3 .list-card .tt:after {content:''; position: absolute; top:1rem; left:0; width:8px; height:32px; background-color: #244276;} 
		.user3 .list-card .nn:after {content:''; position: absolute; top:1rem; left:0; width:8px; height:32px; background-color: #00FF00;} 
	</style>
</head>
<body>
    <div class="home user3 bg-gray" id="wrap">
        <!-- header -->
        <header class="user3">
            <div class="title-box">
                 <h1>방문 목록</h1>
            </div>
            <div class="input-box search">
                 <input type="text" id="searchKeyword" placeholder=" 방문목적을 입력하세요.">
                 <button class="btn-search" onclick="findVisitBySearch();"><img src="../assets/images/btn-search-u3.png" alt="serach"></button>
             </div>
        </header>
        <!-- //header --> 
        <div class="container" style="padding-bottom: 150px;">            
           <!-- list-card -->
           <div class="list-wrap user4">
				<div class="btn-wrap one">
					<button type="submit" class="btn bg-blue lg btn-login" onclick="makeAddVisitHistoryModal();">차량 번호 검색</button>
				</div>
               <h2><em class="color-u3">우리농장</em> 방문신청 목록</h2>
               <div class="list-box user3">
                   <ul class="list-card" id='visitUl'>
                       <li class='sampleVisitList'>
                            <div class="top-box">
                                <p class="tit">페이지 로딩중...</p>
                                <button class="btn-clean">
                                    <img src="../assets/images/icon-clean-ok.png" alt="clean">
                                </button>
                            </div>
                            <div class="bottom-box">
                                <ul>
                                    <li>
                                        <span class="left-tt">출발지</span>
                                        <span class="right-tt">양양거점소독시설</span>
                                    </li>
                                    <li>
                                        <span class="left-tt">도착지</span>
                                        <span class="right-tt">양양거점소독시설</span>
                                    </li>
                                    <li>
                                        <span class="left-tt">방문목적</span>
                                        <span class="right-tt">사료운반</span>
                                    </li>
                                </ul>
                            </div>                           
                           <div class="btn-wrap double">
                               <button class="btn bg-gray md btn-map" onclick="location.href='certificate-deny.html'">미방문</button>
                               <button class="btn bg-blue md btn-apply" onclick="location.href='certificate.html'">방문</button>
                           </div>
                       </li>
                   </ul>
               </div>
              
           </div>
           <!-- //list-card -->
        </div>
        <!-- floating btn -->
        <div class="btn-floating">
			<!-- <a class="bg-pink add"href="javascript:void(0);" onclick="makeAddVisitHistoryModal();"><img src="../assets/images/icon-homeplus.png" alt="바로가기"></a> -->
            <a class="bg-darkblue" href="./homeDisinfection.html">소독시설 이용목록 보러가기<img src="../assets/images/btn-floating-back.png" alt="바로가기"></a>
        </div>
        <!-- floating btn -->
    </div>
</body>
</html>
