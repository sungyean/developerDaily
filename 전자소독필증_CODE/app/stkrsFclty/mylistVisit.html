<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>시설관리자 방문내역</title>
	<link rel="stylesheet" href="../assets/css/common.css">
	<link rel="stylesheet" href="../assets/css/style.css">
	<script type="text/javascript" src="../assets/js/jquery-3.4.1.min.js"></script>
	<script type="text/javascript" src="../assets/js/jquery-ui.min.js"></script>
	<script type="text/javascript" src="../assets/js/custom.js"></script>
	<script type="text/javascript" src="../../assets/js/comm.js"></script>
	<script type="text/javascript" src="../../assets/js/sessionChk.js"></script>
	<script type="text/javascript" src="../../assets/js/conditionModal.js"></script>
	<!-- Data format 시작 -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
	<script type="text/javascript">
		//session Check localStorage에 accountId 없을 경우 login Page로 이동
		sessionChk();
		var loginUserId =  getSigninAccount().accountId;
		var loginUserFacilityid="";

		var defaultAllUrl="";
		var defaultVisitConfirmUrl="";
		var defaultVisitRejectUrl="";
		var defaultAllCountUrl="";
		var defaultVisitConfirmCountUrl="";
		var defaultVisitRejectCountUrl="";
		if(getSigninAccount().cmFarmInfoM!=undefined) {
			loginUserFacilityid=getSigninAccount().cmFarmInfoM.farmNo;

			defaultAllUrl = global.apiUrl+"/visitHistories/estnSearch?"
							+ getEstnUrl("disinfectionFacilityId", loginUserFacilityid ,"NUMBER", "EQ")
							+ "&sort=id,desc";
							

			defaultVisitConfirmUrl = global.apiUrl+"/visitHistories/estnSearch?"  
							+ getEstnUrl("disinfectionFacilityId", loginUserFacilityid ,"NUMBER", "EQ");
							+ getEstnUrl("visitConfmAt","true","BOOLEAN","EQ")
							+ "&sort=id,desc";

			defaultVisitRejectUrl = global.apiUrl+"/visitHistories/estnSearch?" 
							+ getEstnUrl("disinfectionFacilityId", loginUserFacilityid ,"NUMBER", "EQ")
							+ getEstnUrl("visitConfmAt","false","BOOLEAN","EQ")
							+ "&sort=id,desc";

							defaultAllUrl = global.apiUrl+"/visitHistories/estnSearch?"
							+ getEstnUrl("disinfectionFacilityId", loginUserFacilityid ,"NUMBER", "EQ")
							+ "&sort=id,desc";
							

			defaultAllCountUrl = global.apiUrl+"/visitHistories/countBy?"
							+ getEstnUrl("disinfectionFacilityId", loginUserFacilityid ,"NUMBER", "EQ")
							+ "&sort=id,desc";

			defaultVisitConfirmCountUrl = global.apiUrl+"/visitHistories/countBy?"  
							+ getEstnUrl("disinfectionFacilityId", loginUserFacilityid ,"NUMBER", "EQ");
							+ getEstnUrl("visitConfmAt","true","BOOLEAN","EQ")
							+ "&sort=id,desc";

			defaultVisitRejectCountUrl = global.apiUrl+"/visitHistories/countBy?" 
							+ getEstnUrl("disinfectionFacilityId", loginUserFacilityid ,"NUMBER", "EQ")
							+ getEstnUrl("visitConfmAt","false","BOOLEAN","EQ")
							+ "&sort=id,desc";

		} else {
			loginUserFacilityid=getSigninAccount().orgId;

			defaultAllUrl = global.apiUrl+"/visitHistories/estnSearch?" 
							+ getEstnUrl("farmNo", loginUserFacilityid ,"STRING", "EQ")
							+ "&sort=id,desc";

			defaultVisitConfirmUrl = global.apiUrl+"/visitHistories/estnSearch?"  
							+ getEstnUrl("farmNo", loginUserFacilityid ,"STRING", "EQ")
							+ getEstnUrl("visitConfmAt","true","BOOLEAN","EQ")
							+ "&sort=id,desc";

			defaultVisitRejectUrl = global.apiUrl+"/visitHistories/estnSearch?" 
							+getEstnUrl("farmNo", loginUserFacilityid ,"STRING", "EQ")
							+ getEstnUrl("visitConfmAt","false","BOOLEAN","EQ")
							+ "&sort=id,desc";


			defaultAllCountUrl = global.apiUrl+"/visitHistories/countBy?" 
							+ getEstnUrl("farmNo", loginUserFacilityid ,"STRING", "EQ")
							+ "&sort=id,desc";

			defaultVisitConfirmCountUrl = global.apiUrl+"/visitHistories/countBy?"  
							+ getEstnUrl("farmNo", loginUserFacilityid ,"STRING", "EQ")
							+ getEstnUrl("visitConfmAt","true","BOOLEAN","EQ")
							+ "&sort=id,desc";

			defaultVisitRejectCountUrl = global.apiUrl+"/visitHistories/countBy?" 
							+getEstnUrl("farmNo", loginUserFacilityid ,"STRING", "EQ")
							+ getEstnUrl("visitConfmAt","false","BOOLEAN","EQ")
							+ "&sort=id,desc";

		}

		var tempSampleVisitList;
		var sampleVisitList;

		//페이징 처리
		var allCurrentPage = 0;			//현재 페이지
		var allCountPerPage = 10;		//페이지 당 갯수
		var allTotal = 0;				//총 갯수

		var confirmCurrentPage = 0;		//현재 페이지
		var confirmCountPerPage = 10;	//페이지 당 갯수
		var confirmTotal = 0;			//총 갯수

		var rejectCurrentPage = 0;		//현재 페이지
		var rejectCountPerPage = 10;	//페이지 당 갯수
		var rejectTotal = 0;			//총 갯수

		var filter="";

		$(document).ready(function() {
			tempSampleVisitList = $('#sampleVisitLi');
			sampleVisitList = tempSampleVisitList.clone();
			tempSampleVisitList.css("display", "none");

//			var url = "/visitHistory/estnSearch?sort=id,desc&page=0&size=10"+getEstnUrl("farmNo",getSigninAccount().orgId,"STRING","EQ");

			getAllTotalPage(defaultAllCountUrl);
			getConfirmTotalPage(defaultVisitConfirmCountUrl);
			getRejectTotalPage(defaultVisitRejectCountUrl);

			getAllVisitList(defaultAllUrl);
			getConfirmVisitList(defaultVisitConfirmUrl);
			getRejectVisitList(defaultVisitRejectUrl);
			const searchValue=document.getElementById('searchBox');
			//const searchValue=document.querySelector('input[type="search"]');
			const fromDateValue=$('#fromDateValue');
			const toDateValue=$('#toDateValue');
			const orderValue=$('#orderValue');

			$('#btn-condition').click(function() {
				makeConditionModal(searchValue, fromDateValue, toDateValue, orderValue, getMyList);
			})

		});

		function getAllTotalPage(url) {
			$.ajax({
				type: 'GET',
				url: url,
				async: false,
				contentType: "application/json",
				dataType: 'json',
				success: function (res) {
					allTotal=res.page.totalElements;
				}, 
				complete: function (res) {
					//window.location.href="./disinfectionList.html"
				},
				error: function(err) {
					//alert("실패");
				}
			});
		}

		function getConfirmTotalPage(url) {
			$.ajax({
				type: 'GET',
				url: url,
				async: false,
				contentType: "application/json",
				dataType: 'json',
				success: function (res) {
					confirmTotal=res.page.totalElements;
				}, 
				complete: function (res) {
					//window.location.href="./disinfectionList.html"
				},
				error: function(err) {
					//alert("실패");
				}
			});
		}

		function getRejectTotalPage(url) {
			$.ajax({
				type: 'GET',
				url: url,
				async: false,
				contentType: "application/json",
				dataType: 'json',
				success: function (res) {
					rejectTotal=res.page.totalElements;
				}, 
				complete: function (res) {
					//window.location.href="./disinfectionList.html"
				},
				error: function(err) {
					//alert("실패");
				}
			});
		}

		function makeVisitList(data){
			var tempSampleVisitList = sampleVisitList.clone();
			//console.log(tempSampleDisinfectionList[0].children[0])
			tempSampleVisitList[0].children[0].children[0].children[0].innerHTML=data.carNo;//차량번호
			//전자소독필증 발급/미발급 시 이미지 파일 변경
			if(data.edcStatus == "ISSU" || data.edcStatus == "USE_REJECT") {
				tempSampleVisitList[0].children[0].children[0].children[1].innerHTML="<img src='../assets/images/icon-clean-ok.png' alt='clean'>";
			} else {
				tempSampleVisitList[0].children[0].children[0].children[1].innerHTML="<img src='../assets/images/icon-clean-error.png' alt='clean'>";
			}
			tempSampleVisitList[0].children[0].children[0].children[2].children[0].innerHTML="<img src='../assets/images/icon-from.png' alt='출발'>"+data.carNo;
			//tempSampleVisitList[0].children[0].children[0].children[2].children[1].innerHTML="<img src='../assets/images/icon-to-user3.png' alt='도착'>"+data.registDt;

			tempSampleVisitList[0].children[0].children[1].children[0].children[0].children[1].innerText=data.strtpnt;//출발지
			tempSampleVisitList[0].children[0].children[1].children[0].children[1].children[1].innerText=data.dstn;//도착지
			tempSampleVisitList[0].children[0].children[1].children[0].children[2].children[1].innerText=data.visitPurps;//방문목적

			if(data.visitConfmAt==null){
				tempSampleVisitList.addClass('nn')
			} else if (data.visitConfmAt==true) {
				tempSampleVisitList.addClass('tt')
			} else if (data.visitConfmAt==false) {
				tempSampleVisitList.addClass('ff')
			}
			tempSampleVisitList[0].children[0].children[0].children[2].children[1].innerHTML="<img src='../assets/images/icon-to-user3.png' alt='도착'>"+moment(data.registDt).format('YYYY-MM-DD HH:mm:ss');
			
			$("#allUl").append(tempSampleVisitList);
		}


		function makeVisitConfirmList(data) {
			var tempSampleVisitList = sampleVisitList.clone();
			//console.log(tempSampleDisinfectionList[0].children[0])
			tempSampleVisitList[0].children[0].children[0].children[0].innerHTML=data.carNo;//차량번호
			//전자소독필증 발급/미발급 시 이미지 파일 변경
			if(data.edcStatus == "ISSU" || data.edcStatus == "USE_REJECT") {
				tempSampleVisitList[0].children[0].children[0].children[1].innerHTML="<img src='../assets/images/icon-clean-ok.png' alt='clean'>";
			} else {
				tempSampleVisitList[0].children[0].children[0].children[1].innerHTML="<img src='../assets/images/icon-clean-error.png' alt='clean'>";
			}
			tempSampleVisitList[0].children[0].children[0].children[2].children[0].innerHTML="<img src='../assets/images/icon-from.png' alt='출발'>"+data.carNo;
			//tempSampleVisitList[0].children[0].children[0].children[2].children[1].innerHTML="<img src='../assets/images/icon-to-user3.png' alt='도착'>"+data.registDt;

			tempSampleVisitList[0].children[0].children[1].children[0].children[0].children[1].innerText=data.strtpnt;//출발지
			tempSampleVisitList[0].children[0].children[1].children[0].children[1].children[1].innerText=data.dstn;//도착지
			tempSampleVisitList[0].children[0].children[1].children[0].children[2].children[1].innerText=data.visitPurps;//방문목적
			
			tempSampleVisitList.children().children().eq(0).children().eq(2).children().eq(1).remove('.error');
			tempSampleVisitList.children().children().eq(0).children().eq(2).append("<span class='right to user3'><img src='../assets/images/icon-to-user3.png' alt='도착'>"+moment(data.registDt).format('YYYY-MM-DD HH:mm:ss')+"</span>");
			tempSampleVisitList.addClass('tt')
			
			$("#visitTrueUl").append(tempSampleVisitList.clone());
		}


		function makeVisitRejectList(data) {
			var tempSampleVisitList = sampleVisitList.clone();
			//console.log(tempSampleDisinfectionList[0].children[0])
			tempSampleVisitList[0].children[0].children[0].children[0].innerHTML=data.carNo;//차량번호
			//전자소독필증 발급/미발급 시 이미지 파일 변경
			if(data.edcStatus == "ISSU" || data.edcStatus == "USE_REJECT") {
				tempSampleVisitList[0].children[0].children[0].children[1].innerHTML="<img src='../assets/images/icon-clean-ok.png' alt='clean'>";
			} else {
				tempSampleVisitList[0].children[0].children[0].children[1].innerHTML="<img src='../assets/images/icon-clean-error.png' alt='clean'>";
			}
			tempSampleVisitList[0].children[0].children[0].children[2].children[0].innerHTML="<img src='../assets/images/icon-from.png' alt='출발'>"+data.carNo;
			//tempSampleVisitList[0].children[0].children[0].children[2].children[1].innerHTML="<img src='../assets/images/icon-to-user3.png' alt='도착'>"+data.registDt;

			tempSampleVisitList[0].children[0].children[1].children[0].children[0].children[1].innerText=data.strtpnt;//출발지
			tempSampleVisitList[0].children[0].children[1].children[0].children[1].children[1].innerText=data.dstn;//도착지
			tempSampleVisitList[0].children[0].children[1].children[0].children[2].children[1].innerText=data.visitPurps;//방문목적
			
			tempSampleVisitList[0].children[0].children[0].children[2].children[1].innerHTML="<img src='../assets/images/icon-to-user3.png' alt='도착'>"+moment(data.registDt).format('YYYY-MM-DD HH:mm:ss');
			tempSampleVisitList.addClass('ff')
			
			$("#visitFalseUl").append(tempSampleVisitList.clone());
		}

		function getMyList(searcEstnhUrl) {
			$("#allUl").empty();
			$("#visitTrueUl").empty();
			$("#visitFalseUl").empty();

			allCurrentPage = 0;			//현재 페이지
			allTotal = 0;				//총 갯수

			confirmCurrentPage = 0;			//현재 페이지
			confirmTotal = 0;				//총 갯수

			rejectCurrentPage = 0;			//현재 페이지
			rejectTotal = 0;				//총 갯수

			if(searcEstnhUrl != null) {
				filter=searcEstnhUrl;
			}

			getAllTotalPage(defaultAllCountUrl+filter);
			getAllVisitList(defaultAllUrl+filter);

			getConfirmTotalPage(defaultVisitConfirmCountUrl+filter);
			getConfirmVisitList(defaultVisitConfirmUrl+filter);

			getRejectTotalPage(defaultVisitRejectCountUrl+filter);
			getRejectVisitList(defaultVisitRejectUrl+filter);

		}

		function getAllVisitList(url) {
			var page=countAllPage();
			if(page=='MAX') {
			} else {
				$.ajax({
					type: 'GET',
					url: url+page,
					async: false,
					contentType: "application/json",
					dataType: 'json',
					success: function (res) {
						res._embedded.visitHistories.forEach(function(item, index, array){
							makeVisitList(item)
						})
					}, 
					complete: function (res) {
						//window.location.href="./disinfectionList.html"
					},
					error: function(err) {
						//alert("실패");
					}
				});
			}
		}

		function getConfirmVisitList(url) {
			var page=countConfirmPage();
			if(page=='MAX') {
			} else {
				$.ajax({
					type: 'GET',
					url: url+page,
					async: false,
					contentType: "application/json",
					dataType: 'json',
					success: function (res) {
						res._embedded.visitHistories.forEach(function(item, index, array){
							makeVisitConfirmList(item)
						})
					}, 
					complete: function (res) {
						
					},
					error: function(err) {
						//alert("실패");
					}
				});
			}
		}

		function getRejectVisitList(url) {
			var page=countRejectPage();
			if(page=='MAX') {
			} else {
				$.ajax({
					type: 'GET',
					url: url+page,
					async: false,
					contentType: "application/json",
					dataType: 'json',
					success: function (res) {
						res._embedded.visitHistories.forEach(function(item, index, array){
							makeVisitRejectList(item)
						})
					}, 
					complete: function (res) {
						
					},
					error: function(err) {
						//alert("실패");
					}
				});
			}
		}

		function getTotalPage(searchUrl) {
			$.ajax({
				type: 'GET',
				url: defaultAllUrl+searchUrl,
				async: false,
				contentType: "application/json",
				dataType: 'json',
				success: function (res) {
					allTotal=res.page.totalElements;
				}, 
				complete: function (res) {
					//window.location.href="./disinfectionList.html"
				},
				error: function(err) {
					//alert("실패");
				}
			});

			$.ajax({
				type: 'GET',
				url: defaultVisitConfirmUrl+searchUrl,
				async: false,
				contentType: "application/json",
				dataType: 'json',
				success: function (res) {
					confirmTotal=res.page.totalElements;
				}, 
				complete: function (res) {
					//window.location.href="./disinfectionList.html"
				},
				error: function(err) {
					//alert("실패");
				}
			});

			$.ajax({
				type: 'GET',
				url: defaultVisitRejectUrl+searchUrl,
				async: false,
				contentType: "application/json",
				dataType: 'json',
				success: function (res) {
					rejectTotal=res.page.totalElements;
				}, 
				complete: function (res) {
					//window.location.href="./disinfectionList.html"
				},
				error: function(err) {
					//alert("실패");
				}
			});
		}

		function countAllPage() {
			var pageUrl = "";
			if ( allTotal==0 ) {
				pageUrl="MAX";
			} else if( allTotal > allCurrentPage*allCountPerPage) {
				pageUrl="&page="+allCurrentPage+"&size=10";
				allCurrentPage++;
			} else if ( allTotal <= allCurrentPage*allCountPerPage ) {
				pageUrl="MAX";
			}
			return pageUrl;
		}

		function countConfirmPage() {
			var pageUrl = "";
			if ( confirmTotal==0 ) {
				confirmpageUrl="MAX";
			} else if( confirmTotal > confirmCurrentPage*confirmCountPerPage) {
				pageUrl="&page="+confirmCurrentPage+"&size=10";
				confirmCurrentPage++;
			} else if ( confirmTotal <= confirmCurrentPage*confirmCountPerPage ) {
				pageUrl="MAX";
			}
			return pageUrl;
		}

		function countRejectPage() {
			var pageUrl = "";
			if ( rejectTotal==0 ) {
				pageUrl="MAX";
			} else if( rejectTotal > rejectCurrentPage*rejectCountPerPage) {
				pageUrl="&page="+rejectCurrentPage+"&size=10";
				rejectCurrentPage++;
			} else if ( rejectTotal <= rejectCurrentPage*rejectCountPerPage ) {
				pageUrl="MAX";
			}
			return pageUrl;
		}

		$(window).scroll(function () {
			if($(window).scrollTop()-1 < $(document).height() - $(window).height() && $(window).scrollTop()+1 > $(document).height() - $(window).height()) {
				if($(".on")[0]==$(".on").parent().children()[0]) { //발급승인 목록이 선택되었을 경우
					getAllVisitList(defaultAllUrl+filter);
					allCurrentPage++;					
				} else if($(".on")[0]==$(".on").parent().children()[1]) {   //발급거절 목록이 선택되었을 경우				
					getConfirmVisitList(defaultVisitConfirmUrl+filter);
					confirmCurrentPage++;
				} else if($(".on")[0]==$(".on").parent().children()[2]) {   //발급거절 목록이 선택되었을 경우				
					getRejectVisitList(defaultVisitRejectUrl+filter);
					rejectCurrentPage++;
				}
			}
		});

	</script>
	<style>
		.user3 .ff:after {content:''; position: absolute; top:1rem; left:0; width:8px; height:32px; background-color: #ff0000;} 
		.user3 .tt:after {content:''; position: absolute; top:1rem; left:0; width:8px; height:32px; background-color: #244276;} 
		.user3 .nn:after {content:''; position: absolute; top:1rem; left:0; width:8px; height:32px; background-color: #00FF00;} 
	</style>
</head>
<body>
	<div class="mylist user3 bg-gray" id="wrap">
	<!-- header -->
		<header class="user3">
<!-- 			<button class="btn-back">
				<img src="../assets/images/btn-back.png" alt="back">
			</button> -->
			<div class="title-box">
				<h1>마이리스트</h1>
			</div>
		</header>
		<!-- //header -->
		<!-- tab menu -->
		<div class="mylist-tab-menu">
			<ul>
				<li class="on"><a href="#box1">전체</a></li>
				<li><a href="#box2">방문 목록</a></li>
				<li><a href="#box3">미방문 목록</a></li>
			</ul>
		</div>
		<!-- //tab menu -->
		<!-- mylist search box -->
		<div class="mylist-search-box">
			<a class="btn-calendar" id="btn-condition"><img src="../assets/images/btn-calender.png" alt="calendar"></a>
			<div class="input-box search">
				<input type="text" id="searchBox" placeholder="방문목적을 입력하세요.">
				<input type="hidden" id='fromDateValue'>
				<input type="hidden" id='toDateValue'>
				<input type="hidden" id='orderValue'>
				<button class="btn-search"><img src="../assets/images/btn-search-u2.png" alt="serach"></button>
			</div>
		</div>
		<!-- //myllist search box -->
		<div class="container">            
			<!-- mypage list -->
			<div id="box1" class="mylist-wrap user3">
				<ul id="allUl">
					<li id="sampleVisitLi">
						<a href="#">
							<div class="top-box">
								<p class="tit"></p>
								<button class="btn-clean">
									<img src="../assets/images/icon-clean-ok.png" alt="clean">
								</button>
								<div class="row">
									<span class="left from"><img src="../assets/images/icon-from.png" alt="출발"></span>
									<span class="right to error"><img src="../assets/images/icon-to-error.png" alt="도착"></span>
								</div>
							</div>
							<div class="bottom-box">
								<ul>
									<li>
										<span class="left-tt">출발지</span>
										<span class="right-tt"></span>
									</li>
									<li>
										<span class="left-tt">도착지</span>
										<span class="right-tt"></span>
									</li>
									<li>
										<span class="left-tt">방문목적</span>
										<span class="right-tt"></span>
									</li>
								</ul>
							</div>
						</a>
					</li>
				</ul>
		</div>
		<div id="box2" class="mylist-wrap user3">
				<ul id="visitTrueUl">
				</ul>
			</div>
			<div id="box3" class="mylist-wrap user3">
				<ul id="visitFalseUl">
				</ul>
			</div>
		<!-- //mypage list -->
		</div>
		<!-- floating btn -->
		<div class="btn-floating">
			<a class="bg-darkblue" href="./mylistDisinfection.html">소독시설 이용목록 보러가기<img src="../assets/images/btn-floating-back.png" alt="바로가기"></a>
		</div>
		
		<!-- floating btn -->        
	</div>
</body>
</html>
